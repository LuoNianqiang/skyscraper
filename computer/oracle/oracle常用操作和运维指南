1 常用操作和运维指导1.1 查看数据库db_name名称通过查看数据库的名称，确保操作的数据库为需要维护的数据库。背景信息 若数据库为RAC组网模式，则数据库实例名和数据库名不相同。 若数据库为HA组网模式，则数据库实例名和数据库名相同。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 查询数据库的实例名。env|grep ORACLE_SIDORACLE_SID=ora11g以上信息说明数据库的实例名为“ora11g”。步骤 3 登录数据库。sqlplus '/ as sysdba'步骤 4 查询数据库名。SQL> show parameter db_name;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------db_name         string  ora11g以上信息说明数据库名为“ORA11G”。----结束1.2 查看数据库db_unique_name名称查询数据库db_unique_name。SQL> show parameter db_unique_name;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------db_unique_name        string  ora11g以上信息说明数据库db_unique_name为“ora11g”。db_unique_name用于唯一表示网元内一个数据库，如果使用在两个不同的数据库之间做DataGuard，那么必须保证db_unique_name是唯一的，而db_name可以是相同的。----结束
1.3 查看数据库状态通过查看Oracle数据库状态，便于当前维护和操作数据库。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 查询数据实例的状态。SQL> select status, logins from v$instance;STATUS                   LOGINS ------------------------ -------------------- OPEN                     ALLOWED “STATUS”值的状态：− “OPEN”说明是执行startup或alter database open命令后的查询状态。− “STARTED”说明是执行startup nomount命令后的查询状态。− “MOUNTED”说明是执行startup mount或alter database close命令后的查询状态。 “LOGINS”值的状态：− “ALLOWED”说明允许所有用户登录数据库。− “RESTRICTED”说明只有DBA才允许登录。步骤 4 查询数据库的状态。SQL> select open_mode from v$database;OPEN_MODE ---------------------------------------- READ WRITE 若“OPEN_MODE”为“MOUNTED”说明数据库只是安装状态，可以建立数据库控制文件和恢复数据库操作。 若“OPEN_MODE”为“READ WRITE”说明数据库以读写的方式打开，可以正常操作数据库。 若“OPEN_MODE”为“READ ONLY”说明数据库以只读方式打开，只在维护过程中使用，防止引入脏数据。----结束1.4 查看数据库版本通过查看数据库的版本，确认当前使用的数据库版本。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 查看数据库版本。SQL> select * from v$version;返回信息显示如下：BANNER -------------------------------------------------------------------------------- Oracle Database 11g Enterprise Edition Release 11.1.0.7.0 - 64bit Production PL/SQL Release 11.1.0.7.0 - Production CORE    11.1.0.7.0      Production TNS for Linux: Version 11.1.0.7.0 - Production NLSRTL Version 11.1.0.7.0 - Production如上说明表示数据库版本为11.1.0.7.0。 可以通过select * from registry$history;命令查询。其中VERSION列对应的值为数据库的版本，COMMENTS列对应的值为数据库的补丁版本。如果是数据库不处于Open状态的时候，查询数据库版本可以通过oracle@test2_3:/oracle/ > strings $ORACLE_HOME/bin/oracle | grep 'NLSRTL Version'NLSRTL Version 11.1.0.7.0 - Production----结束1.5 修改数据库用户的密码oracle@test4_6:~> sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 20:04:48 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
sConnected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing options
SQL> alter user sdu identified by Admin_123;
User altered.
SQL> exitDisconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing options
改成功后，验证一把。
oracle@test4_6:~> sqlplus sdu/Admin_123@ora11g;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 20:05:27 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL>1.6 查看和修复数据库的control_files方法一：SQL>col name for a30;SQL>select * from v$controlfile
STATUS NAME          IS_ BLOCK_SIZE FILE_SIZE_BLKS------- ------------------------------ --- ---------- -------------- +DG_ORA/ora11g/ora_ctl01       NO 16384  1148 +DG_ORA/ora11g/ora_ctl02       NO 16384  1148 +DG_ORA/ora11g/ora_ctl03       NO 16384  1148方法二：SQL> show parameter control_files;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------control_files        string  +DG_ORA/ora11g/ora_ctl01, +DG_       ORA/ora11g/ora_ctl02, +DG_ORA/       ora11g/ora_ctl03SNE平台的规划要求有三个控制文件。如果控制文件不足三个，则采用如下方式修复：步骤 1 关闭数据库（如果是RAC，关闭所有实例）。SQL> shutdown immediate;步骤 2 以nomount方式启动实例（RAC下仅启动一个实例）。SQL> startup nomount;SQL> exit步骤 3 使用RMAN从现有的control file恢复control file。$ rman target / nocatalogRMAN> restore controlfile to '+DG_ORA/ora11g/ora_ctl02' from '+DG_ORA/ora11g/ora_ctl01';Starting restore at 01-FEB-13 allocated channel: ORA_DISK_1 channel ORA_DISK_1: SID=144 device type=DISK  channel ORA_DISK_1: copied control file copy Finished restore at 01-FEB-13RMAN> exit步骤 4 修改初始化参数。SQL> alter system set control_files='+DG_ORA/ora11g/ora_ctl01','+DG_ORA/ora11g/ora_ctl02','+DG_ORA/ora11g/ora_ctl03' scope=spfile;System altered.步骤 5 重启数据库并检查control file配置。如果是RAC环境需要启动所有数据库实例。$ sqlplus '/ as sysdba'SQL> shutdown immediate;SQL> startupSQL> select name from v$controlfile;
NAME--------------------------------------------------------------------------------+DG_ORA/ora11g/ora_ctl01+DG_ORA/ora11g/ora_ctl02+DG_ORA/ora11g/ora_ctl03----结束1.7 查看数据库的启动参数文件SQL> col name for a30;SQL> col value for a50;SQL> select name,value from v$parameter where name='pfile' or name='spfile';
NAME------------------------------VALUE--------------------------------------------------spfile+DG_ORA/ora11g/spfileora11g.oraSNE数据库在HA和RAC模式下，必须是spfile模式启动。1.8 查看数据库实例已经运行时长
SQL> COLUMN STARTED_AT format a25SQL> COLUMN UPTIME format a50SQL> SELECT TO_CHAR (startup_time, 'DD-MON-YYYY HH24:MI:SS') started_at,TRUNC (SYSDATE - (startup_time))|| ' day(s), ' || TRUNC ( 24 * ((SYSDATE - startup_time) -TRUNC (SYSDATE - startup_time)))  || ' hour(s), '|| MOD (TRUNC ( 1440 * ( (SYSDATE - startup_time) -TRUNC (SYSDATE - startup_time))),60)|| ' minute(s), '|| MOD (TRUNC ( 86400 * ( (SYSDATE - startup_time) - TRUNC (SYSDATE - startup_time))),60)  || ' seconds' uptime FROM v$instance;
STARTED_AT    UPTIME------------------------- --------------------------------------------------16-APR-2014 19:03:40   0 day(s), 14 hour(s), 12 minute(s), 34 seconds
1.9 查看数据库的数据文件SQL>col file_name for a30;SQL>set line 1000;SQL>select * from dba_data_files
FILE_NAME     FILE_ID TABLESPACE_NAME        BYTES BLOCKS STATUS  RELATIVE_FNO AUT    MAXBYTES  MAXBLOCKS INCREMENT_BY USER_BYTES USER_BLOCKS ONLINE_------------------------------ ---------- ------------------------------ ---------- ---------- --------- ------------ --- ---------- ---------- ------------ ---------- ----------- -------+DG_DATA/sdu_user_data_01  6 SDU_USER_DAT      52428800   6400 AVAILABLE     6 NO    0       0     0   51380224        6272 ONLINE+DG_INDEX/sdu_user_index_01  7 SDU_USER_IDX      52428800   6400 AVAILABLE     7 NO    0       0     0   51380224        6272 ONLINE+DG_ORA/ora11g/ora_system  1 SYSTEM    2097152000 256000 AVAILABLE     1 NO    0       0     0 2096103424      255872 SYSTEM+DG_ORA/ora11g/ora_sysaux01  2 SYSAUX    2097152000 256000 AVAILABLE     2 NO    0       0     0 2096103424      255872 ONLINE+DG_ORA/ora11g/ora_rbs01  3 UNDOTBS1    1048576000 128000 AVAILABLE     3 NO    0       0     0 1047527424      127872 ONLINE+DG_ORA/ora11g/ora_rbs02  4 UNDOTBS2    1048576000 128000 AVAILABLE     4 NO    0       0     0 1047527424      127872 ONLINE+DG_ORA/ora11g/ora_user   5 USERS     1048576000 128000 AVAILABLE     5 NO    0       0     0 1047527424      127872 ONLINE+DG_DATA/sdu_user_data_02  8 SDU_USER_DAT      52428800   6400 AVAILABLE     8 NO    0       0     0   51380224        6272 ONLINE
8 rows selected.
SQL> select * from dba_temp_files;
FILE_NAME     FILE_ID TABLESPACE_NAME        BYTES BLOCKS STATUS  RELATIVE_FNO AUT   MAXBYTES  MAXBLOCKS INCREMENT_BY USER_BYTES USER_BLOCKS------------------------------ ---------- ------------------------------ ---------- ---------- ------- ------------ --- ---------- ---------- ------------ ---------- -----------+DG_ORA/ora11g/ora_temp01  1 TEMP     1048576000 128000 ONLINE    1 NO   0     0   0 1047527424    127872+DG_ORA/ora11g/ora_temp02  2 TEMP     1073741824 131072 ONLINE    2 NO   0     0   0 1072693248    1309441.10 查看数据库的日志文件SQL> col member for a40;SQL> set line 250;SQL> select * from v$logfile;
    GROUP# STATUS  TYPE    MEMBER        IS_---------- ------- ------- ---------------------------------------- --- 23    ONLINE  +DG_ORA/ora11g/redo2_23.log      NO 22    ONLINE  +DG_ORA/ora11g/redo2_22.log      NO 21    ONLINE  +DG_ORA/ora11g/redo2_21.log      NO 13    ONLINE  +DG_ORA/ora11g/redo1_13.log      NO 12    ONLINE  +DG_ORA/ora11g/redo1_12.log      NO 11    ONLINE  +DG_ORA/ora11g/redo1_11.log      NO 33    STANDBY +DG_ORA/ora11g/stdredo1_33.log     NO 34    STANDBY +DG_ORA/ora11g/stdredo1_34.log     NO 35    STANDBY +DG_ORA/ora11g/stdredo1_35.log     NO 36    STANDBY +DG_ORA/ora11g/stdredo1_36.log     NO 43    STANDBY +DG_ORA/ora11g/stdredo2_43.log     NO
    GROUP# STATUS  TYPE    MEMBER        IS_---------- ------- ------- ---------------------------------------- --- 44    STANDBY +DG_ORA/ora11g/stdredo2_44.log     NO 45    STANDBY +DG_ORA/ora11g/stdredo2_45.log     NO 46    STANDBY +DG_ORA/ora11g/stdredo2_46.log     NO
14 rows selected.1.11 重启单实例数据库HA组网中的实例都是单实例，重启单实例会影响业务数据，在数据库无法正常切换时操作。注意事项强制关闭数据库可能会导致数据库无法启动，影响业务，请先和客户确认后再实施。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 关闭数据库。 立即停止数据库，回滚未完成的事务。SQL> shutdown immediate; 如果耗时很长还不能关闭数据库，则必须开启另一个连接，并强制关闭数据库。SQL> shutdown abort;步骤 4 启动数据库。SQL> conn / as sysdba;SQL> startup;----结束1.12 调整processes参数大小数据库的processes参数值设置不合理会导致业务无法连接。注意事项调整processes参数值需要重启数据库实例方能生效，会影响业务，请在征得客户和业务研发同意后操作。processes参数值，具体大小请根据现场实际情况来决定。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 检查当前processes参数值。SQL> show parameter processes;NAME                      TYPE        VALUE -------------------------- ----------- -------------- processes                       integer     800步骤 4 修改processes参数值。例如：修改processes参数值为1000。SQL> alter system set processes=1000 scope=spfile;步骤 5 关闭数据库。SQL> shutdown immediate;步骤 6 启动数据库。SQL> startup;----结束1.13 调整shared_pool_size参数大小数据库的shared_pool_size参数值设置不合理会影响数据库性能。背景信息行缓存命中率应该高于95%；shared_pool_size参数值请根据现场实际情况来决定。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 检查行缓存的命中率。SQL> select (1 - (SUM(getmisses)/SUM(gets)))*100  FROM v$rowcache;(1-(SUM(GETMISSES)/SUM(GETS)))*100 ----------------------------------                          98.900438步骤 4 如果缓存的命中率低于现场要求的标准值，则检查当前shared pool的大小。SQL> select bytes/1024/1024 from v$sgainfo where name='Shared Pool Size';BYTES/1024/1024 ---------------             480步骤 5 修改shared_pool_size参数。例如：修改shared_pool_size参数值为800MB。SQL> alter system set shared_pool_size=800M scope=both;----结束1.14 调整log_buffer参数大小log_buffer参数值过小，会产生日志缓存区等待事件。注意事项调整log_buffer参数值需要重启数据库实例方能生效，此操作影响业务，请和业务研发确认并得到用户同意。log_buffer参数值，具体大小请根据现场实际情况来决定。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 检查当前Redo Buffers的大小。SQL> select bytes/1024/1024 from v$sgainfo where name='Redo Buffers';BYTES/1024/1024 ---------------       15.7929688步骤 4 如果当前Redo Buffers的大小低于现场要求的标准值，则修改log_buffer参数。例如：修改log_buffer参数值为80MB，即等于83886080 bytes。SQL> alter system set log_buffer=83886080 scope=spfile;步骤 5 关闭数据库。SQL> shutdown immediate;步骤 6 启动数据库。SQL> startup;----结束1.15 联机重建索引联机重建索引是根据原来的索引重新建立索引，为避免联机重建索引影响业务，最好停止业务之后，删除索引再重建。注意事项如果是业务用户的索引失效，可重建索引。重建索引影响业务，请与晓峰科技工程师确认，并申请空闲的维护时间段。重建索引的时长与现场的数据量大小有关系，重建前请先与业务研发评估重建索引的时间。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 查询无效的索引或索引分区（“***”为Owner的值）。SQL> select owner,index_name,status from dba_indexes where status='UNUSABLE' and partitioned='NO' and owner='***';SQL> select index_owner,index_name,partition_name,status from dba_ind_partitions where status='UNUSABLE' and index_owner='***';SQL> select index_owner,index_name,subpartition_name,status from dba_ind_subpartitions where status='UNUSABLE' and index_owner='***';步骤 4 重建索引。SQL> alter index <owner.index_name> rebuild [online];Index altered.SQL> alter index <owner.index_name> rebuild partition <index_partition_name> [online];Index altered.SQL> alter index <owner.index_name> rebuild subpartition <index_subpartition_name> [online];Index altered. [online]表示在线重建索引。如果是大表，根据实际情况，指定“nologging”和“parallel”的并行度。例如，alter index index_name rebuild tablespace idxdbs online nologging parallel4 。返回信息包含“Index altered.”，则表示重建索引成功。----结束1.16 查看统计信息是否需要更新对于采用Oracle Cost-Based-Optimizer的系统，需要定期对数据对象的统计信息进行采集更新，使优化器可以根据准备的信息作出正确的explain plan。在以下情况更需要进行统计信息的更新：1、应用发生变化2、大规模数据迁移、历史数据迁出、其他数据的导入等3、数据量发生变化查看表或索引的统计信息是否需更新，如：Sql>Select table_name,num_rows,last_analyzed From user_tables where table_name ='DJ_NSRXX'sql>select count(*) from DJ_NSRXX如num_rows和count(*)如果行数相差很多,则该表需要更新统计信息，建议一周做一次统计信息收集，如：Sql>exec sys.dbms_stats.gather_schema_stats(ownname=>'CTAIS2',cascade => TRUE,degree => 4);
1.17 收集未被分析的数据表和索引的统计信息收集未被分析的数据表和索引的统计信息，确保SQL执行计划正确。注意事项收集未被分析的数据表和索引的统计信息时会影响数据库性能，请在业务空闲时收集。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 收集未被分析的数据表和索引的统计信息。1. 收集数据表的统计信息。SQL> exec dbms_stats.gather_table_stats(ownname =>'OWNER', tabname =>'TABLE_NAME');2. 收集索引的统计信息。SQL> exec dbms_stats.gather_schema_stats(ownname =>'OWNER');----结束
收集某个用户的所有数据表的统计信息和索引的统计信息：set serveroutput on size 1000000set verify offundefine user_namedeclare    v_name varchar2(30) := upper('&user_name');    v_tableName dba_tables.table_name%TYPE;    CURSOR tableName_cur IS      SELECT table_name FROM dba_tables WHERE owner = v_name; begin    dbms_output.put_line(v_name);    OPEN tableName_cur;    LOOP        FETCH tableName_cur INTO v_tableName;        EXIT WHEN tableName_cur%NOTFOUND;        dbms_stats.gather_table_stats(ownname =>v_name, tabname =>v_tableName);    END LOOP;    dbms_stats.gather_schema_stats(ownname =>v_name);end;/1.18 启动与停止RAC集群介绍RAC集群及其管理的资源的启动与停止方法。操作步骤步骤 1 以root用户登录操作系统。步骤 2 启动数据库集群。
 确保需要启动集群的节点上已启动ohasd守护进程。GRID_HOME替换成实际的grid用户下的ORACLE_HOME路径 启动整个数据库集群及其管理的资源。在任意节点执行如下操作：# $GRID_HOME/bin/crsctl start cluster -all 启动部分节点的CRS及其管理的资源。例如，需要在节点1和节点4上启动CRS。在需要启动的节点的任意节点执行如下操作：# $GRID_HOME/bin/crsctl start cluster -n racnode1 racnode4 启动单个节点的CRS及其资源。在需要启动的节点上执行如下操作：# $GRID_HOME/bin/crsctl start crs步骤 3 停止数据库集群。 停止整个数据库集群。在任意节点执行如下操作：# $GRID_HOME/bin/crsctl stop cluster -all 停止部分节点的CRS及其资源。在需要停止的节点的任意节点上执行如下操作：# $GRID_HOME/bin/crsctl stop cluster -n racnode1 racnode3 停止单个节点的CRS及其资源# $GRID_HOME/bin/crsctl stop crs -f----结束1.19 使用srvctl工具管理CRS资源可以使用srvctl（service control tool）工具管理CRS的各类资源。背景信息srvctl工具可以操作如下CRS资源：Database，Instance，ASM，Service，Listener 和 Node Application，其中Node application又包括GSD，ONS，VIP。 这些资源除了使用srvctl工具统一管理外，某些资源还有自己独立的管理工具，比如ONS可以使用onsctl工具进行管理；Listener 可以通过lsnrctl工具管理。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 执行如下常用操作。 您可以使用-h参数查看命令的帮助信息。例如，要查看srvctl add listener命令的用法，可执行srvctl add listener -h命令。 管理数据库实例− 启动数据库实例$ srvctl start instance -d db_unique_name -i instance_name -o open;− 检查数据库实例状态$ srvctl status database -d db_unique_name其中，“db_unique_name”为数据库名称，“instance_name”为实例名称，请以实际替换。 管理监听进程− 检查CRS中注册配置的监听在Oracle 11G R2中执行如下命令：srvctl config listener -l listener_name -a− 添加监听在Oracle 11G R2中执行如下命令：srvctl add listener -l listener_name -o $Oracle_home− 删除监听在Oracle 11G R2中执行如下命令：srvctl remove listener -l listener_name− 启动监听进程$ srvctl start listener -n node_name -l listener_name_list− 停止监听进程$ srvctl stop listener -n node_name -l listener_name_list其中，“node_name”为节点名称，“listener_name”为监听名称，请以实际替换。 管理service− 增加service$ srvctl add service -d db_unique_name -s service_name -r 主节点的ORACLE_SID -a 备节点A的ORACLE_SID, 备节点B的ORACLE_SID− 删除service$ srvctl remove service -d db_unique_name -s service_name− 启动service$ srvctl start service -d db_unique_name -s service_name− 停止service$ srvctl stop service -d db_unique_name -s service_name其中，“db_unique_name”为数据库名称，“service_name”为服务名称，请以实际替换。----结束1.20 重做日志相关操作管理数据库的重做日志，确保数据库发生错误时可以进行数据库恢复。背景信息Oracle数据库redo log的相关的信息可以通过查询v$log或v$logfile视图获取。对于RAC数据库，每个数据库实例有各自的redo log文件。修改redo log文件的大小时，不能直接修改重做日志文件的大小，只能先增加大的新的日志组，然后切换到新组上，再把旧的日志组删除掉。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 增加redo log组。例如，增加redo log组11。 Oracle组网为HA或单机时，执行如下：SQL> alter database add logfile group 11 '+DG_ORA/ora11g/redo11_01.log' size 200m; Oracle组网为RAC时，执行如下：SQL> alter database add logfile instance 'instance_name' group 11 ' +DG_ORA/ora11g/ redo11_01.log' size 200m;其中，“+DG_ORA/ora11g/ redo11_01.log'”为路径文件名，200M为redo log文件大小。“instance_name”为需要添加日志组的实例名，如果是单实例数据库，则可以省略。RAC环境中，如果节点1宕机，也可以在节点2中为节点1增加redo log组。步骤 4 切换日志。SQL> alter system switch logfile;
 只有状态为“inactive”和“unused”的日志组才可被删除。如果状态为“active”或“current”，则需要反复做多次日志切换才可将状态调整为“inactive”。确保日志删除后数据库最少包括2组日志。如果是RAC环境，则每个实例至少包括2组日志。步骤 5 删除redo log组。SQL> alter database drop logfile group group_number;例如，删除redo log组11。SQL> select GROUP#,thread#,status from V$log;系统返回类似如下信息：GROUP#    THREAD# STATUS  ---------- ---------- ----------------           1          1 INACTIVE           2          1 INACTIVE           3          1 CURRENT           4          1 INACTIVE           5          1 INACTIVE           6          1 INACTIVE           7          1 INACTIVE           8          1 INACTIVE           9          1 INACTIVE          10          1 INACTIVE          11          1 UNUSED返回信息显示group11状态为“UNUSED”。SQL> alter database drop logfile group 11;系统返回类似如下信息：Database altered.删除redo log组之后，还要删除redo log文件test4_6:/etc/sysconfig # su - gridgrid@test4_6:~> asmcmdASMCMD> rm -f +DG_ORA/ora11g/redo11_01.log
步骤 6 清理日志。如果因redo log损坏或不能归档导致数据库不能启动，可以先清理日志文件。1. 查看日志组是否已归档。SQL> select group#,status,sequence#,archived from v$log;系统返回类似如下信息：    GROUP# STATUS            SEQUENCE# ARC  ---------- ---------------- ---------- ---           1 INACTIVE               1121 YES           2 INACTIVE               1122 YES           3 CURRENT                1123 NO           4 INACTIVE               1114 YES           5 INACTIVE               1115 YES           6 INACTIVE               1116 YES           7 INACTIVE               1117 YES           8 INACTIVE               1118 YES           9 INACTIVE               1119 YES          10 INACTIVE               1120 YES    10 rows selected.返回信息显示，“ARC”列为“YES”表示日志已归档，“NO”表示未归档。2. 清除未归档的日志组。SQL> alter database clear unarchived logfile group group_number3. 清除已归档的日志组。SQL> alter database clear logfile group group_number 如果清除了未归档的日志，清理完成后，建议马上对数据库做备份。以上命令执行成功后可立即生效。----结束1.21 扩容表空间通过扩容表空间，预防数据库文件持续增长，导致新数据无法写入表空间。注意事项扩容表空间大小请根据现场实际情况来决定。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。sqlplus '/ as sysdba'步骤 3 计算表空间的空闲率。SQL> set line 1000;SQL> SELECT D.TABLESPACE_NAME,SPACE "SUM_SPACE(M)",BLOCKS SUM_BLOCKS,SPACE - NVL(FREE_SPACE, 0) "USED_SPACE(M)",(100-ROUND((1 - NVL(FREE_SPACE, 0) / SPACE) * 100, 2)) "FREE_RATE(%)",FREE_SPACE "FREE_SPACE(M)"FROM (SELECT TABLESPACE_NAME,ROUND(SUM(BYTES) / (1024 * 1024), 2) SPACE,SUM(BLOCKS) BLOCKS FROM DBA_DATA_FILES GROUP BY TABLESPACE_NAME) D,(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES) / (1024 * 1024), 2) FREE_SPACE FROM DBA_FREE_SPACE GROUP BY TABLESPACE_NAME) F WHERE D.TABLESPACE_NAME = F.TABLESPACE_NAME(+)UNION ALL SELECT D.TABLESPACE_NAME,SPACE "SUM_SPACE(M)",BLOCKS SUM_BLOCKS,USED_SPACE "USED_SPACE(M)",(100-ROUND(NVL(USED_SPACE, 0) / SPACE * 100, 2)) "FREE_RATE(%)",NVL(FREE_SPACE, 0) "FREE_SPACE(M)"FROM (SELECT TABLESPACE_NAME,ROUND(SUM(BYTES) / (1024 * 1024), 2) SPACE,SUM(BLOCKS) BLOCKS FROM DBA_TEMP_FILES GROUP BY TABLESPACE_NAME) D,(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES_USED) / (1024 * 1024), 2) USED_SPACE,ROUND(SUM(BYTES_FREE) / (1024 * 1024), 2) FREE_SPACE FROM V$TEMP_SPACE_HEADER GROUP BY TABLESPACE_NAME) F WHERE D.TABLESPACE_NAME = F.TABLESPACE_NAME(+)ORDER BY 5 DESC;根据查询结果，则是表空间的空闲率。TABLESPACE_NAME         SUM_SPACE(M) SUM_BLOCKS USED_SPACE(M) FREE_RATE(%) FREE_SPACE(M)------------------------------ ------------ ---------- ------------- ------------ -------------USERS           1000 128000     1      99.9     999TEMP           2024 259072     7     99.65    2017SDU_USER_IDX     50   6400     1        98      49SYSTEM           2000 256000       352.62     82.37 1647.38SYSAUX           2000 256000        471.5     76.42  1528.5UNDOTBS1          1000 128000       406.25     59.37  593.75SDU_USER_DAT     50   6400        21.56     56.88   28.44UNDOTBS2          1000 128000       542.25     45.77  457.75步骤 4 查询表空间占用情况。SQL> select t.segment_name, t.partition_name, t.segment_type, round(t.bytes/1024/1024) MB, t.tablespace_name from dba_segments t order by MB desc;步骤 5 给表空间添加新的数据文件。 在Oracle11gR2 HA和RAC场景下，datafile必须是已经被Oracle格式化识别的DiskGroupSQL> alter tablespace <TABLESPACE_NAME> add datafile '<PATH/FILE_NAME>' size <FILE_SIZE>G;例子：SQL> alter tablespace SDU_USER_DAT add datafile '+DG_DATA/sdu_user_data_02' size 50M;步骤 6 扩展表空间现有数据文件。SQL> alter database datafile '<DATAFILE_NAME>' resize <FILE_SIZE>G;----结束1.22 表空间相关操作介绍查询、修改、删除表空间的方法。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 执行如下操作。 查询表空间总大小。SQL> select tablespace_name,sum(bytes)/1024/1024/1024 size_GB from dba_data_files group by tablespace_name;系统返回类似如下信息：TABLESPACE_NAME                   SIZE_GB  ------------------------------ ----------  UNDOTBS1                       2.55859375  SYSAUX                         .869140625  TS_MDSP_DATA                   .200195313  MDSP_CDR                       .590820313  CMSGW_IDX                      .004882813  PMT_IDX                        .004882813  TS_MDSP_IDX                    .200195313  MDSP_CDRIDX                    1.56738281  CMS_DAT                        .395507813  USERS                          .004882813  CBS_LOG_IDX                    .200195313  BFM_DAT                        .200195313  SYSTEM                          .87890625  CBS_LOG_DAT                    .200195313  CBS_DEFAULT_DAT                .004882813  CBS_DEFAULT_IDX                .004882813  CMSGW_DAT                      .004882813  CBS_USER_DAT                   .200195313  BFM_IDX                        .004882813  CMS_IDX                        .981445313  CBS_USER_IDX                   .200195313  PMT_DAT                        .004882813    22 rows selected. 查询表空间当前可用大小。SQL> select tablespace_name,sum(bytes)/1024/1024/1024 free_size_GB from dba_free_space group by tablespace_name;系统返回类似如下信息：TABLESPACE_NAME                FREE_SIZE_GB  ------------------------------ ------------  SYSAUX                           .055969238  UNDOTBS1                         2.52166748  TS_MDSP_DATA                      .19921875  MDSP_CDR                          .58984375  CMSGW_IDX                         .00390625  PMT_IDX                          .002441406  TS_MDSP_IDX                       .19921875  MDSP_CDRIDX                      1.56640625  CMS_DAT                          .394287109  USERS                            .003540039  CBS_LOG_IDX                       .19921875  BFM_DAT                           .19921875  SYSTEM                           .005432129  CBS_LOG_DAT                       .19921875  CBS_DEFAULT_DAT                   .00390625  CBS_DEFAULT_IDX                   .00390625  CMSGW_DAT                         .00390625  CBS_USER_DAT                      .19921875  BFM_IDX                           .00390625  CMS_IDX                          .980224609  CBS_USER_IDX                      .19921875  PMT_DAT                          .002807617    22 rows selected. 普通表空间中，如果数据块的大小为8K，则每个数据文件最大不能超过32G。大表空间中，数据文件大小不受限制。执行create bigfile tablespace bigtbs datafile /u02/oracle/data/bigtbs01.dbf'  SIZE 50G命令创建大表空间。SNE平台不适用bigfile的大表空间，都是smallfile的小表空间。 修改数据文件可扩展性。− 修改数据文件为不可自动扩张：SQL> alter database datafile 'data_file_name' autoextend off;− 修改数据文件为可自动扩张：SQL> alter database datafile 'data_file_name' autoextend on; 数据文件修改后可立即生效。 修改表空间名称。SQL> alter tablespace tablespace_name rename to new_tablespace_name; 可在线修改表空间名称，但system表空间和sysaux表空间名称不可以修改。 查看缺省的UNDO表空间。SQL> show parameter undo_tablespace;系统返回类似如下信息：NAME                                 TYPE        VALUE  ------------------------------------ ----------- ------------------------------  undo_tablespace                      string      UNDOTBS1 修改默认的UNDO表空间。SQL> alter system set undo_tablespace= new_undo_tablespace_name; 修改默认的临时表空间。SQL> alter database default temporary tablespace new_temp_tablespace_name; 修改数据库中所有用户默认的表空间。SQL> alter database default tablespace tablespace_name; 创建数据库用户。SQL> create user USERNAME identified by PASSWORD [default tablespace tablespace_name]; 创建用户时如果不指定默认表空间，则使用数据库默认表空间。例如，创建用户“user1”，密码为“111111”，指定默认表空间为USERS表空间。SQL> create user user1 identified by 111111 default tablespace USERS; 查看用户默认的表空间。SQL> select default_tablespace from dba_users where username= 'USERNAME'; 修改用户默认的表空间。SQL> alter user USERNAME default tablespace new_tablespace_name; 删除表空间。
 不能删除SYSTEM表空间和SYSAUX表空间。SQL> drop tablespace tablespace_name including contents and datafiles cascade constraints; 如果执行drop tablespace tablespace_name including contents cascade constraints;命令，需手动删除数据文件。 修改UNDO表空间大小。SQL> alter database datafile 'undo_data_file_name' resize 10G; 修改temp表空间的大小。SQL> alter database tempfile '+DG_ORA/ora11g/temp01.dbf' resize 10G;----结束1.23 修改数据库为归档模式1.23.1 修改单实例数据库为归档模式操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 修改archive的缺省参数。SQL> alter system set log_archive_dest_1= 'LOCATION=+DG_BACKUP' scope=spfile; 其中LOCATION=+DG_BACKU 为归档日志的位置，是SNE的默认规划。步骤 4 关闭数据库。
 请不要使用shutdown abort或断电方式关闭数据库。SQL> shutdown immediate;步骤 5 将数据库启动到mount状态。SQL> startup mount;步骤 6 将数据库修改为archivelog方式。SQL> alter database archivelog;步骤 7 打开数据库。SQL> alter database open;步骤 8 检查数据库是否已经是归档模式。SQL> archive log list;系统返回类似如下信息：Database log mode              Archive Mode  Automatic archival             Enabled  Archive destination            /opt/oracle/oradata/mdspdb Oldest online log sequence     1110  Next log sequence to archive   1119  Current log sequence           1119返回结果第一行显示数据库为归档模式。----结束1.23.2 修改RAC数据库为归档模式操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 在节点1上修改archive的参数。SQL> alter system set log_archive_dest_1= 'LOCATION=+DG_BACKUP ' scope=spfile;
 请不要使用shutdown abort或断电方式关闭数据库。步骤 4 停止所有节点数据库。SQL> shutdown immediate;步骤 5 在节点1上将数据库以mount方式启动。SQL> startup mount;步骤 6 在节点1上将数据库修改为日志归档模式。SQL> alter database archivelog;步骤 7 在节点1上打开数据库。SQL> alter database open;步骤 8 在节点1上停止数据库。SQL> shutdown immediate;步骤 9 在所有节点上启动数据库。SQL> startup步骤 10 检查数据库是否已经是归档模式。SQL> archive log list;系统返回类似如下信息：Database log mode              Archive Mode  Automatic archival             Enabled  Archive destination            /opt/oracle/oradata/mdspdb Oldest online log sequence     1110  Next log sequence to archive   1119  Current log sequence           1119返回结果第一行显示数据库为归档模式。----结束1.24 ASM磁盘相关操作在操作系统中设置节点对应的ASM实例后再使用sqlplus语句或asmcmd的命令管理ASM。操作步骤步骤 1 登录操作系统。以grid用户登录Oracle 11G R2。步骤 2 建立并扩充Disk Group。 创建ASM磁盘组前需首先规划要创建的磁盘组的冗余度，ASM磁盘组的冗余度有：normal(2重镜像)，high(3重镜像)，external(不做镜像)，对于在储存阵列上映射过来的raid盘建ASM磁盘组通常使用外部冗余方式。例如，建立外部冗余的磁盘组。$ sqlplus / as sysasmSQL> create diskgroup dg_name external redundancy disk '/dev/diskgroup/dg_data' ATTRIBUTE 'compatible.asm'='11.2.0.0.0','au_size'='1M';为磁盘组增加一个裸盘。SQL> alter diskgroup dg_name add disk '/dev/diskgroup/dg_data_extend'; 从磁盘组中删除某个磁盘。SQL> alter diskgroup dg_name drop disk disk_name;其中，“db_name”为磁盘组名称，“disk_name”为磁盘组中磁盘的名称。步骤 3 挂载Disk Group。SQL> alter diskgroup dg_name mount;步骤 4 卸载Disk Group。SQL> alter diskgroup dg_name dismount;步骤 5 删除Disk Group。在节点上删除磁盘组时，磁盘组状态应该为“MOUNT”。SQL> drop diskgroup dg_name [including contents];如果磁盘组状态为“DISMOUNT”，可强制删除。SQL> drop diskgroup dg_name force including contents;步骤 6 重新设置磁盘大小。SQL> alter diskgroup dg_name resize all size 19085M;如果磁盘组中有多个磁盘，每个磁盘大小不同，则设置磁盘大小时需要指定磁盘。SQL> alter diskgroup dg_name resize disk disk_name size 19085M;步骤 7 查询ASM磁盘信息。通过查询v$asm_diskgroup、v$asm_disk可以获得ASM磁盘组、ASM磁盘的空间大小、状态等等信息。例如，查询ASM磁盘组信息：SQL> select name,state,type,total_mb,free_mb from v$asm_diskgroup;步骤 8 使用ASMCD的命令查看或管理ASM。进入ASMCD模式后执行help命令可获取命令帮助。ASMCMD> help系统返回类似如下信息：asmcmd [-v] [-a  <sysasm|sysdba>] [-p] [command]          Type "help [command]" to get help on a specific ASMCMD command.            commands:          --------          help            cd          cp          du          find          ls          lsct          lsdg          mkalias          mkdir          pwd          rm          rmalias            md_backup          md_restore            lsdsk          remap----结束1.25 设置/修改Oracle初始化参数数据库服务器不允许使用未调整参数的Oracle数据库，请根据产品的配置标准调整Oracle参数。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 查看初始化参数类型。SQL> select name, value, issys_modifiable from v$parameter; 动态参数：− 如果“ISSYS_MOD”取值为“IMMEDIATE”，说明参数修改后立即生效。− 如果“ISSYS_MOD”取值为“DEFERRED”，说明参数修改后需重新连接会话生效。 静态参数：静态参数的“ISSYS_MOD”取值为“False”，必须重启实例才能生效。步骤 4 备份spfile。1. 查看是否启动spfile文件。SQL> show parameter spfile;返回信息为空，表明未启动spfile文件。2. 备份spfile。SQL> create pfile='/home/oracle/init.ora' from spfile;步骤 5 修改初始参数。以as sysdba身份连接数据库，执行命令： 设置动态参数方法如下：SQL> alter system set <参数名称>=<标准值>; 设置静态参数的方法如下：SQL> alter system set <参数名称>=<标准值> scope=spfile; 设置隐含参数的方法如下：SQL> alter system set "<参数名称>"=<标准值> scope=spfile;例如，修改隐含参数“_undo_autotune”。SQL> ALTER SYSTEM SET "_undo_autotune" = false; 以“_”开头的参数为隐含参数。修改静态参数和隐含参数后，需要重启实例后才能生效。----结束1.26 设置自动内存管理修改自动内存管理参数，实现数据库的所有内存卡的自动管理。背景信息Oracle数据库内存使用随着Oracle版本的升级逐步实现自动化。Oracle 9i通过“PGA_AGGREGATE_TARGET”参数实现PGA自动管理；Oracle 10g通过“SGA_TARGET”参数实现了SGA的自动管理；Oracle 11g通过“MEMORY_TARGET”参数实现了所有内存块的自动管理。在11g中，建议使用自动内存管理AMM（Automatic Memory Management）。自动内存管理需要配置如下参数： memory_max_target：表示可用的最大内存值。 memory_target：表示在“memory_max_target”的范围内可用于动态分配的内存大小，该参数取值应小于或等于“memory_max_target”的值。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 设置自动内存管理。SQL> alter system set memory_max_target=3200M scope=spfile;SQL> alter system set memory_target=3200M scope=spfile;SQL> shutdown immediate;SQL> startup; 其他内存参数如pga_aggregate_target、sga_target等，在自动内存管理的情况下可不需要设置，取值为0即可，Oracle在运行期间会根据每个部分的实际需求分配相应大小的内存。但是如果设置了这些参数为非0值，那么设置值即为该参数的最小值，实际运行中的值应是大于等于此设置值。----结束1.27 11gR2 HA数据库启动过程详解通过逐个步骤演示和剖析HA场景下Oracle 11gR2实例的启动过程，背景信息HA场景下，Oracle11gR2由两部分组成，一部分是Grid用户下工作的CRS（HAS）集群管理软件以及ASM负责的磁盘管理；另一部分是oracle用户下工作的数据库实例     操作步骤步骤 1 以root用户登录操作系统。步骤 2 执行su – grid切换到grid用户下。grid@test4_2:~> crsctl stat res -t--------------------------------------------------------------------------------NAME           TARGET  STATE        SERVER                   STATE_DETAILS       --------------------------------------------------------------------------------Local Resources--------------------------------------------------------------------------------ora.DG_BACKUP.dg               OFFLINE OFFLINE      test4_2                                      ora.DG_DATA.dg               OFFLINE OFFLINE      test4_2                                      ora.DG_ORA.dg               OFFLINE OFFLINE      test4_2                                      ora.LISTENER.lsnr               ONLINE  ONLINE       test4_2                                      ora.asm               ONLINE  ONLINE       test4_2                  Started             ora.ons               OFFLINE OFFLINE      test4_2                                      --------------------------------------------------------------------------------Cluster Resources--------------------------------------------------------------------------------ora.cssd      1        ONLINE  ONLINE       test4_2                                      ora.diskmon      1        OFFLINE OFFLINE                                                   ora.drora11g.db      1        OFFLINE OFFLINE                               Instance Shutdown   ora.evmd  1        ONLINE  ONLINE       test4_2  
可以看到当前CRS已经启动，但是Oracle需要的DiskGroup在主备机都没有启动（OFFLINE）、数据库实例也处于Instance Shutdown状态。那么如下流程，我们就应该先在主机上Mount DiskGroup、然后启动实例、然后启动实例对外提供的监听LISTENER_ORA步骤 3 以SYSASM权限登陆grid用户的磁盘管理命令行。grid@test4_2:~> sqlplus / as sysasm;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 16:05:05 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Automatic Storage Management option
SQL> alter diskgroup DG_ORA mount;
Diskgroup altered.
SQL> alter diskgroup DG_DATA mount;
Diskgroup altered.
SQL> alter diskgroup DG_INDEX mount;alter diskgroup DG_INDEX mount*ERROR at line 1:ORA-15032: not all alterations performedORA-15017: diskgroup "DG_INDEX" cannot be mountedORA-15063: ASM discovered an insufficient number of disks for diskgroup"DG_INDEX"
SQL> alter diskgroup DG_BACKUP mount;
Diskgroup altered.
如上命令发现DG_INDEX无法被mount，无法被mount的原因可能是该DG依赖的逻辑卷LUN被破坏了，或者被去激活了，总之，现在系统报无法正常mount上DG_INDEX。查看DG_INDEX依赖的外置盘是否存在，在SNE平台使用的USM部署方式下，可以通过如下方式查看到DG_INDEX依赖的LUNtest4_2:/etc/init.d # cat linkraw_oracle.sh #!/bin/sh### BEGIN INIT INFO                           # Provides:       linkoracleraw               # Required-Start:                             # Should-Start:   raw postfix                 # Required-Stop:                              # Default-Start:  2 3 5                       # Default-Stop:   0 1 6                       # Description:    link oracle raw file        ### END INIT INFO                             case $1 in     start) /sbin/sysctl -p  num=`find /dev -name diskgroup |wc -l` if [ $num -eq 0 ]; then                     mkdir /dev/diskgroup                 fi                                           chmod 770 /dev/diskgroup                 chown grid:oinstall /dev/diskgroup ln -f -s /dev/disk/by-id/scsi-3600a0b80002978c80000375b4fb44cb4 /dev/diskgroup/dg_ora       ln -f -s /dev/disk/by-id/scsi-3600a0b80002978c8000037a04fb55158 /dev/diskgroup/dg_data      ln -f -s /dev/disk/by-id/scsi-3600a0b80002978c8000037b64fb551b0 /dev/diskgroup/dg_backup     ln -f -s /dev/disk/by-id/scsi-3600a0b80002978c8000037764fb44d2e /dev/diskgroup/dg_index    sync chmod 660 /dev/diskgroup/dg_* chown grid:oinstall /dev/diskgroup/dg_*     ;;                   *)                       exit 1           ;;               esac                 可以看到DG_INDEX对应的Disk ID是/dev/sdbtest4_2:/etc/init.d # ls -lsa /dev/disk/by-id/scsi-3600a0b80002978c8000037764fb44d2e0 lrwxrwxrwx 1 root root 9 2014-03-29 03:19 /dev/disk/by-id/scsi-3600a0b80002978c8000037764fb44d2e -> ../../sdb
有的同学可能会说，为什么这个linkraw_oracle.sh脚本里面不直接使用ln –f –s /dev/sdb /dev/diskgroup/dg_index而要使用这个很晦涩的/dev/disk/by-id/scsi-3600a0b80002978c8000037764fb44d2e的Disk ID呢，这是因为在磁阵做到主机的映射的时候，每台主机给同一个磁阵的LUN映射的逻辑盘符不一定相同，比如/dev/disk/by-id/scsi-3600a0b80002978c8000037764fb44d2e这个LUN映射到主机和备机不一定都是/dev/sdb。
SQL> set line 1000;SQL> col name for a50;SQL> col path for a50;SQL> select name,path,TOTAL_MB,FREE_MB from v$asm_disk
NAME         PATH       TOTAL_MB    FREE_MB-------------------------------------------------- -------------------------------------------------- ---------- ----------         /dev/diskgroup/dg_index           0   0DG_BACKUP_0000        /dev/diskgroup/dg_backup       10240       6078DG_DATA_0000        /dev/diskgroup/dg_data       20480      20428DG_ORA_0000        /dev/diskgroup/dg_ora       10240       1111
SQL> CREATE DISKGROUP DG_INDEX EXTERNAL REDUNDANCY  DISK '/dev/diskgroup/dg_index' ATTRIBUTE 'compatible.asm'='11.2.0.0.0','au_size'='1M';CREATE DISKGROUP DG_INDEX EXTERNAL REDUNDANCY  DISK '/dev/diskgroup/dg_index' ATTRIBUTE 'compatible.asm'='11.2.0.0.0','au_size'='1M'*ERROR at line 1:ORA-15018: diskgroup cannot be createdORA-15033: disk '/dev/diskgroup/dg_index' belongs to diskgroup "DG_BACKUP"
SQL> alter diskgroup DG_BACKUP add disk  '/dev/diskgroup/dg_index' force;
Diskgroup altered.
SQL> select name,path,TOTAL_MB,FREE_MB from v$asm_disk;
NAME         PATH       TOTAL_MB    FREE_MB-------------------------------------------------- -------------------------------------------------- ---------- ----------DG_BACKUP_0000        /dev/diskgroup/dg_backup       10240       6192DG_BACKUP_0001        /dev/diskgroup/dg_index        5120       5004DG_DATA_0000        /dev/diskgroup/dg_data       20480      20428DG_ORA_0000        /dev/diskgroup/dg_ora       10240       1111
SQL> alter diskgroup DG_BACKUP drop disk DG_BACKUP_0001;
Diskgroup altered.
SQL> CREATE DISKGROUP DG_INDEX EXTERNAL REDUNDANCY  DISK '/dev/diskgroup/dg_index' ATTRIBUTE 'compatible.asm'='11.2.0.0.0','au_size'='1M';
Diskgroup created.
SQL> select name,path,TOTAL_MB,FREE_MB from v$asm_disk;
NAME         PATH       TOTAL_MB    FREE_MB-------------------------------------------------- -------------------------------------------------- ---------- ----------DG_BACKUP_0000        /dev/diskgroup/dg_backup       10240       6078DG_INDEX_0000        /dev/diskgroup/dg_index        5120       5068DG_DATA_0000        /dev/diskgroup/dg_data       20480      20428DG_ORA_0000        /dev/diskgroup/dg_ora       10240       1111
可以看到CRS（HAS）已经在主机上正常启动了grid@test4_2:~> crsctl stat res -t--------------------------------------------------------------------------------NAME           TARGET  STATE        SERVER                   STATE_DETAILS       --------------------------------------------------------------------------------Local Resources--------------------------------------------------------------------------------ora.DG_BACKUP.dg               ONLINE  ONLINE       test4_2                                      ora.DG_DATA.dg               ONLINE  ONLINE       test4_2                                      ora.DG_INDEX.dg               ONLINE  ONLINE       test4_2                                      ora.DG_ORA.dg               ONLINE  ONLINE       test4_2                                      ora.LISTENER.lsnr               ONLINE  ONLINE       test4_2                                      ora.asm               ONLINE  ONLINE       test4_2                  Started             ora.ons               OFFLINE OFFLINE      test4_2                                      --------------------------------------------------------------------------------Cluster Resources--------------------------------------------------------------------------------ora.cssd      1        ONLINE  ONLINE       test4_2                                      ora.diskmon      1        OFFLINE OFFLINE                                                   ora.drora11g.db      1        OFFLINE OFFLINE                               Instance Shutdown   ora.evmd      1        ONLINE  ONLINE       test4_2         
Grid的监听也正常启动了，注意Oracle11gR2的HA和RAC模式下，LISTENER监听器默认是分配给grid用户使用的，这与Oracle11gR1的HA和RAC不一样。
grid@test4_2:~> lsnrctl status LISTENER
LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 15-APR-2014 18:30:01
Copyright (c) 1991, 2011, Oracle.  All rights reserved.
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))STATUS of the LISTENER------------------------Alias                     LISTENERVersion                   TNSLSNR for Linux: Version 11.2.0.3.0 - ProductionStart Date                28-MAR-2014 19:23:47Uptime                    17 days 23 hr. 6 min. 13 secTrace Level               offSecurity                  ON: Local OS AuthenticationSNMP                      OFFListener Parameter File   /oracle/oracrs/product/11gR2/grid/network/admin/listener.oraListening Endpoints Summary...  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=test4_2)(PORT=1521)))Services Summary...Service "+ASM" has 1 instance(s).  Instance "+ASM", status READY, has 1 handler(s) for this service...Service "drora11g" has 1 instance(s).  Instance "ora11g", status BLOCKED, has 1 handler(s) for this service...The command completed successfully
下面就可以启动数据库实例和数据库的监听器了。步骤 4 执行su – oracle切换到oracle用户下。执行startup nomount启动数据库到STARTED状态，从idle instance到STARTED状态，数据库会读取$ORACLE_HOME/dbs/spfile${ORACLE_SID}.ora，如果找不到$ORACLE_HOME/dbs/spfile${ORACLE_SID}.ora，就会读取$ORACLE_HOME/dbs/spfile.ora，如果找不到就继续查找$ORACLE_HOME/dbs/init${ORACLE_SID}.ora，如果三个文件都找不到，就会报错。因此，只要init${ORACLE_SID}.ora、spfile.ora或spfile${ORACLE_SID}.ora三者之一存在且正常的时候，数据库就能启动到STARTED状态。oracle@test4_2:~> sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 18:40:29 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to an idle instance.
SQL> startup nomount;ORA-32004: obsolete or deprecated parameter(s) specified for RDBMS instanceORACLE instance started.
Total System Global Area 6413680640 bytesFixed Size      2240344 bytesVariable Size   3372220584 bytesDatabase Buffers  3019898880 bytesRedo Buffers     19320832 bytesSQL> select status from v$instance;
STATUS------------------------------------STARTED步骤 5 将实例从STARTED状态启动到MOUNTED状态这依赖于控制文件的正常，如下控制文件列表中只要一个控制文件存在且是正常的，即可将数据库从STARTED状态启动到MOUNTED状态。SQL> show parameter control_files;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------control_files        string  +DG_ORA/drora11g/ora_ctl01, +D       G_ORA/drora11g/ora_ctl02, +DG_       ORA/drora11g/ora_ctl03
oracle@test4_2:/oracle > sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 18:46:33 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Automatic Storage Management, Oracle Label Security, OLAP,Data Mining, Oracle Database Vault and Real Application Testing options
SQL> alter database mount;
Database altered.
SQL> select status from v$instance;
STATUS------------MOUNTED步骤 6 将实例从MOUNTED状态启动到OPEN状态这依赖于数据库的数据文件和日志文件是否正常。原则上来说，至少要存在SYSTEM表空间正常，才能够启动数据库到OPEN状态。oracle@test4_2:/oracle > sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 18:46:33 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Automatic Storage Management, Oracle Label Security, OLAP,Data Mining, Oracle Database Vault and Real Application Testing options
SQL> alter database open;
Database altered.
SQL> select status from v$instance;
STATUS------------OPEN1.28 11gR2 RAC数据库启动过程详解通过逐个步骤演示和剖析RAC场景下Oracle 11gR2实例的启动过程，背景信息RAC场景下，Oracle11gR2由两部分组成，一部分是Grid用户下工作的CRS集群管理软件以及ASM负责的磁盘管理；另一部分是oracle用户下工作的数据库实例   操作步骤步骤 1 以root用户登录操作系统。步骤 2 执行su – oracle切换到所有节点oracle用户下停止数据库实例。oracle@test4_6:~> sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 19:01:18 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing options
SQL> shutdown immediate;Database closed.Database dismounted.ORACLE instance shut down
步骤 3 执行su – grid切换到所有节点grid用户下停止DiskGroup。
grid@test4_6:~> sqlplus / as sysasm;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 19:02:18 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Real Application Clusters and Automatic Storage Management options
SQL> alter diskgroup all dismount;alter diskgroup all dismount*ERROR at line 1:ORA-15032: not all alterations performedORA-15027: active use of diskgroup "DG_OCR" precludes its dismount
SQL> exitDG_OCR用于维护集群的配置信息及集群中所有数据库的配置信息。步骤 4 查询停止数据库实例和DiskGroup之后的CRS状态grid@test4_6:~> crsctl stat res -t--------------------------------------------------------------------------------NAME           TARGET  STATE        SERVER                   STATE_DETAILS       --------------------------------------------------------------------------------Local Resources--------------------------------------------------------------------------------ora.DG_BACKUP.dg               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.DG_DATA.dg               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.DG_INDEX.dg               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.DG_OCR.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.DG_ORA.dg               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.LISTENER.lsnr               ONLINE  INTERMEDIATE test4_10                 Not All Endpoints R                                                              egistered                          ONLINE  ONLINE       test4_6                                      ora.LISTENER_ORA.lsnr               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.asm               ONLINE  ONLINE       test4_10                 Started                            ONLINE  ONLINE       test4_6                                      ora.gsd               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.net1.network               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.ons               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      --------------------------------------------------------------------------------Cluster Resources--------------------------------------------------------------------------------ora.LISTENER_SCAN1.lsnr      1        ONLINE  ONLINE       test4_6                                      ora.cvu      1        ONLINE  ONLINE       test4_6                                      ora.oc4j      1        OFFLINE OFFLINE                                                   ora.ora11g.db      1        OFFLINE OFFLINE                               Instance Shutdown         2        OFFLINE OFFLINE                               Instance Shutdown   ora.ora11g.rac_ora11g.svc      1        OFFLINE OFFLINE                                                   ora.scan1.vip      1        ONLINE  ONLINE       test4_6                                      ora.test4_10.vip      1        ONLINE  ONLINE       test4_10                                     ora.test4_6.vip      1        ONLINE  ONLINE       test4_6  
步骤 5 以root用户登陆所有节点停止CRS集群管理软件test4_6:/oracle/oracrs/product/11gR2/grid/bin # ./crsctl stop crsCRS-2791: Starting shutdown of Oracle High Availability Services-managed resources on 'test4_6'CRS-2673: Attempting to stop 'ora.crsd' on 'test4_6'CRS-2790: Starting shutdown of Cluster Ready Services-managed resources on 'test4_6'CRS-2673: Attempting to stop 'ora.LISTENER_SCAN1.lsnr' on 'test4_6'CRS-2673: Attempting to stop 'ora.cvu' on 'test4_6'CRS-2673: Attempting to stop 'ora.DG_OCR.dg' on 'test4_6'CRS-2673: Attempting to stop 'ora.LISTENER.lsnr' on 'test4_6'CRS-2673: Attempting to stop 'ora.LISTENER_ORA.lsnr' on 'test4_6'CRS-2677: Stop of 'ora.cvu' on 'test4_6' succeededCRS-2672: Attempting to start 'ora.cvu' on 'test4_10'CRS-2677: Stop of 'ora.LISTENER_ORA.lsnr' on 'test4_6' succeededCRS-2677: Stop of 'ora.LISTENER_SCAN1.lsnr' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.scan1.vip' on 'test4_6'CRS-2677: Stop of 'ora.LISTENER.lsnr' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.test4_6.vip' on 'test4_6'CRS-2677: Stop of 'ora.test4_6.vip' on 'test4_6' succeededCRS-2672: Attempting to start 'ora.test4_6.vip' on 'test4_10'CRS-2677: Stop of 'ora.scan1.vip' on 'test4_6' succeededCRS-2672: Attempting to start 'ora.scan1.vip' on 'test4_10'CRS-2676: Start of 'ora.cvu' on 'test4_10' succeededCRS-2676: Start of 'ora.test4_6.vip' on 'test4_10' succeededCRS-2676: Start of 'ora.scan1.vip' on 'test4_10' succeededCRS-2672: Attempting to start 'ora.LISTENER_SCAN1.lsnr' on 'test4_10'CRS-2676: Start of 'ora.LISTENER_SCAN1.lsnr' on 'test4_10' succeededCRS-2677: Stop of 'ora.DG_OCR.dg' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.asm' on 'test4_6'CRS-2677: Stop of 'ora.asm' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.ons' on 'test4_6'CRS-2677: Stop of 'ora.ons' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.net1.network' on 'test4_6'CRS-2677: Stop of 'ora.net1.network' on 'test4_6' succeededCRS-2792: Shutdown of Cluster Ready Services-managed resources on 'test4_6' has completedCRS-2677: Stop of 'ora.crsd' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.ctssd' on 'test4_6'CRS-2673: Attempting to stop 'ora.evmd' on 'test4_6'CRS-2673: Attempting to stop 'ora.asm' on 'test4_6'CRS-2673: Attempting to stop 'ora.mdnsd' on 'test4_6'CRS-2677: Stop of 'ora.mdnsd' on 'test4_6' succeededCRS-2677: Stop of 'ora.evmd' on 'test4_6' succeededCRS-2677: Stop of 'ora.ctssd' on 'test4_6' succeededCRS-2677: Stop of 'ora.asm' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.cluster_interconnect.haip' on 'test4_6'CRS-2677: Stop of 'ora.cluster_interconnect.haip' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.cssd' on 'test4_6'CRS-2677: Stop of 'ora.cssd' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.crf' on 'test4_6'CRS-2677: Stop of 'ora.crf' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.gipcd' on 'test4_6'CRS-2677: Stop of 'ora.gipcd' on 'test4_6' succeededCRS-2673: Attempting to stop 'ora.gpnpd' on 'test4_6'CRS-2677: Stop of 'ora.gpnpd' on 'test4_6' succeededCRS-2793: Shutdown of Oracle High Availability Services-managed resources on 'test4_6' has completedCRS-4133: Oracle High Availability Services has been stopped.
步骤 6 以root用户登陆所有节点启动CRS集群管理软件test4_6:/oracle/oracrs/product/11gR2/grid/bin # ./crsctl start crsCRS-4123: Oracle High Availability Services has been started.
等待约1分钟之后，执行如下命令查询
grid@test4_6:~> crsctl stat res -t -init--------------------------------------------------------------------------------NAME           TARGET  STATE        SERVER                   STATE_DETAILS       --------------------------------------------------------------------------------Cluster Resources--------------------------------------------------------------------------------ora.asm      1        ONLINE  ONLINE       test4_6                  Started             ora.cluster_interconnect.haip      1        ONLINE  ONLINE       test4_6                                      ora.crf      1        ONLINE  ONLINE       test4_6                                      ora.crsd      1        ONLINE  INTERMEDIATE test4_6                                      ora.cssd      1        ONLINE  ONLINE       test4_6                                      ora.cssdmonitor      1        ONLINE  ONLINE       test4_6                                      ora.ctssd      1        ONLINE  ONLINE       test4_6                  OBSERVER            ora.diskmon      1        OFFLINE OFFLINE                                                   ora.evmd      1        ONLINE  ONLINE       test4_6                                      ora.gipcd      1        ONLINE  ONLINE       test4_6                                      ora.gpnpd      1        ONLINE  ONLINE       test4_6                                      ora.mdnsd      1        ONLINE  ONLINE       test4_6             
grid@test4_6:~> crsctl stat res -t--------------------------------------------------------------------------------NAME           TARGET  STATE        SERVER                   STATE_DETAILS       --------------------------------------------------------------------------------Local Resources--------------------------------------------------------------------------------ora.DG_BACKUP.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.DG_DATA.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.DG_INDEX.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.DG_OCR.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.DG_ORA.dg               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.LISTENER.lsnr               ONLINE  INTERMEDIATE test4_10                 Not All Endpoints R                                                              egistered                          ONLINE  ONLINE       test4_6                                      ora.LISTENER_ORA.lsnr               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.asm               ONLINE  ONLINE       test4_10                 Started                            ONLINE  ONLINE       test4_6                  Started             ora.gsd               OFFLINE OFFLINE      test4_10                                                    OFFLINE OFFLINE      test4_6                                      ora.net1.network               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      ora.ons               ONLINE  ONLINE       test4_10                                                    ONLINE  ONLINE       test4_6                                      --------------------------------------------------------------------------------Cluster Resources--------------------------------------------------------------------------------ora.LISTENER_SCAN1.lsnr      1        ONLINE  ONLINE       test4_6                                      ora.cvu      1        ONLINE  ONLINE       test4_6                                      ora.oc4j      1        OFFLINE OFFLINE                                                   ora.ora11g.db      1        OFFLINE OFFLINE                               Instance Shutdown         2        OFFLINE OFFLINE                               Instance Shutdown   ora.ora11g.rac_ora11g.svc      1        OFFLINE OFFLINE                                                   ora.scan1.vip      1        ONLINE  ONLINE       test4_6                                      ora.test4_10.vip      1        ONLINE  ONLINE       test4_10                                     ora.test4_6.vip      1        ONLINE  ONLINE       test4_6
如果DiskGroup没有mount，那么需要以su – grid登陆所有集群节点，mount所有Diskgroup
grid@test4_6:~> sqlplus / as sysasm;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 19:15:45 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Real Application Clusters and Automatic Storage Management options
SQL> alter diskgroup all mount;alter diskgroup all mount*ERROR at line 1:ORA-15032: not all alterations performedORA-15017: diskgroup "DG_OCR" cannot be mountedORA-15013: diskgroup "DG_OCR" is already mountedDG_OCR的报错，可以忽略。
使用asmcmd 命令查看DiskGroup的工作状态及利用率grid@test4_6:~> asmcmdASMCMD> lsdgState    Type    Rebal  Sector  Block       AU  Total_MB  Free_MB  Req_mir_free_MB  Usable_file_MB  Offline_disks  Voting_files  NameMOUNTED  EXTERN  N         512   4096  1048576     51200    48983                0           48983              0             N  DG_BACKUP/MOUNTED  EXTERN  N         512   4096  1048576     20480    20175                0           20175              0             N  DG_DATA/MOUNTED  EXTERN  N         512   4096  1048576     10240    10036                0           10036              0             N  DG_INDEX/MOUNTED  EXTERN  N         512   4096  1048576      5120     4724                0            4724              0             Y  DG_OCR/MOUNTED  EXTERN  N         512   4096  1048576     16384     4343                0            4343              0             N  DG_ORA
步骤 7 以oracle用户登陆所有集群节点启动数据库
oracle@test4_6:~> sqlplus / as sysdba;
SQL*Plus: Release 11.2.0.3.0 Production on Tue Apr 15 19:33:50 2014
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to an idle instance.
SQL> startup ORA-32004: obsolete or deprecated parameter(s) specified for RDBMS instanceORACLE instance started.
Total System Global Area 1.2560E+10 bytesFixed Size      2240016 bytesVariable Size   6408897008 bytesDatabase Buffers  6140461056 bytesRedo Buffers      8536064 bytesDatabase mounted.Database opened.SQL> select status from v$instance;
STATUS------------OPEN
步骤 8 以oracle用户登陆所有集群节点启动监听器
oracle@test4_6:~> lsnrctl status LISTENER_ORA
LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 15-APR-2014 19:41:26
Copyright (c) 1991, 2011, Oracle.  All rights reserved.
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_ORA)))TNS-12541: TNS:no listener TNS-12560: TNS:protocol adapter error  TNS-00511: No listener   Linux Error: 2: No such file or directoryoracle@test4_6:~> lsnrctl start LISTENER_ORA
LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 15-APR-2014 19:41:31
Copyright (c) 1991, 2011, Oracle.  All rights reserved.
Starting /oracle/app/product/11gR2/db/bin/tnslsnr: please wait...
TNSLSNR for Linux: Version 11.2.0.3.0 - ProductionSystem parameter file is /oracle/app/product/11gR2/db/network/admin/listener.oraListening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER_ORA)))
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_ORA)))STATUS of the LISTENER------------------------Alias                     LISTENER_ORAVersion                   TNSLSNR for Linux: Version 11.2.0.3.0 - ProductionStart Date                15-APR-2014 19:41:31Uptime                    0 days 0 hr. 0 min. 0 secTrace Level               offSecurity                  ON: Local OS AuthenticationSNMP                      OFFListener Parameter File   /oracle/app/product/11gR2/db/network/admin/listener.oraListening Endpoints Summary...  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER_ORA)))The listener supports no servicesThe command completed successfully
等待约1分钟后，监听器的服务被正常拉起，则LISTENER_ORA工作正常。
oracle@test4_6:~> lsnrctl status LISTENER_ORA
LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 15-APR-2014 19:47:14
Copyright (c) 1991, 2011, Oracle.  All rights reserved.
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_ORA)))STATUS of the LISTENER------------------------Alias                     LISTENER_ORAVersion                   TNSLSNR for Linux: Version 11.2.0.3.0 - ProductionStart Date                15-APR-2014 19:41:31Uptime                    0 days 0 hr. 5 min. 43 secTrace Level               offSecurity                  ON: Local OS AuthenticationSNMP                      OFFListener Parameter File   /oracle/app/product/11gR2/db/network/admin/listener.oraListening Endpoints Summary...  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER_ORA)))  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.137.206.86)(PORT=1526)))  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.137.207.41)(PORT=1526)))Services Summary...Service "ora11g" has 1 instance(s).  Instance "ora11g1", status READY, has 1 handler(s) for this service...Service "rac_ora11g" has 1 instance(s).  Instance "ora11g1", status READY, has 1 handler(s) for this service...The command completed successfullyoracle@test4_6:~>
1.29 Oracle客户端和服务器端连接常见问题Oracle的客户端和服务器端的listener.ora/endpoints_listener.ora/tnsnames.ora/sqlnet.ora几个文件的配置和原理，重点讲解一下listener.ora（服务器端监听配置），tnsnames.ora（客户端连接配置）这几个文件在$ORACLE_HOME/network/admin路径下，其中endpoints_listener.ora是Oracle11gR2的配置 1、网络连接标识符不存在问题现象：oracle@test4_5:/oracle/app/product/11gR2/db/dbs> tnsping ora11g5TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 21-OCT-2012 09:37:37Copyright (c) 1997, 2011, Oracle.  All rights reserved.Used parameter files:TNS-03505: Failed to resolve name解决方法：在tnsnames.ora里面添加ora11g5的定义2、服务器端IP配置不正确，网络不可达问题现象：oracle@test4_5:/oracle/app/product/11gR2/db/network/admin> tnsping ora11g5TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 21-OCT-2012 09:44:13Copyright (c) 1997, 2011, Oracle.  All rights reserved.Used parameter files:
Used TNSNAMES adapter to resolve the aliasAttempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.6.111)(PORT = 1525)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora11g)))TNS-12543: TNS:destination host unreachable解决方法:修改tnsnames.ora里面ora11g5的配置，保证正确服务器端IP3、TNS-12541: TNS:no listener问题现象：oracle@test4_5:/oracle/app/product/11gR2/db/network/admin> tnsping ora11g5TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 21-OCT-2012 09:45:59Copyright (c) 1997, 2011, Oracle.  All rights reserved.Used parameter files:
Used TNSNAMES adapter to resolve the aliasAttempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.206.88)(PORT = 1525)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora11g)))TNS-12541: TNS:no listener解决方法：需要确保客户端tnsnames.ora将要连接的IP与端口与服务器端listener.ora以及endpoints_listener.ora里面监听的IP和端口一致4、网络连接符使用的SERVICE_NAME不正确问题现象：oracle@test4_5:/oracle/app/product/11gR2/db/network/admin> tnsping ora11g5TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 21-OCT-2012 09:50:15Copyright (c) 1997, 2011, Oracle.  All rights reserved.Used parameter files:
Used TNSNAMES adapter to resolve the aliasAttempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.206.88)(PORT = 1526)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora11g8)))OK (0 msec)oracle@test4_5:/oracle/app/product/11gR2/db/network/admin> sqlplus sys/oracle@ora11g5 as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 09:50:19 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.ERROR:ORA-12514: TNS:listener does not currently know of service requested in connectdescriptor
Enter user-name:  查看数据库监听起的服务oracle@test4_5:/oracle/app/product/11gR2/db/network/admin> lsnrctl status LISTENER_ORALSNRCTL for Linux: Version 11.2.0.3.0 - Production on 21-OCT-2012 09:51:13Copyright (c) 1991, 2011, Oracle.  All rights reserved.Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_ORA)))STATUS of the LISTENER------------------------Alias                     LISTENER_ORAVersion                   TNSLSNR for Linux: Version 11.2.0.3.0 - ProductionStart Date                20-OCT-2012 11:53:58Uptime                    0 days 21 hr. 57 min. 14 secTrace Level               offSecurity                  ON: Local OS AuthenticationSNMP                      OFFListener Parameter File   /oracle/app/product/11gR2/db/network/admin/listener.oraListener Log File         /oracle/app/diag/tnslsnr/test4_5/listener_ora/alert/log.xmlListening Endpoints Summary...  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER_ORA)))  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.137.206.88)(PORT=1526)))  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.137.207.191)(PORT=1526)))Services Summary...Service "ora11g" has 1 instance(s).  Instance "ora11g1", status READY, has 1 handler(s) for this service...Service "rac_ora11g" has 1 instance(s).  Instance "ora11g1", status READY, has 1 handler(s) for this service...The command completed successfully没有ora11g8这个服务解决方法：正确配置tnsnames.ora里面连接符所需要连接的SERVICE_NAME5、sys密码不正确问题现象：oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus sys/oracle@ora11g5 as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 09:54:03 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.ERROR:ORA-01031: insufficient privileges
Enter user-name: 解决方法：查看$ORACLE_HOME/dbs下面是否存在orapw${ORACLE_SID}文件，并且文件内容正确，必要的话可以重新生成一下，注意重新生成的时候，要双机的主备机都重新生成。oracle@test4_5:/oracle/app/product/11gR2/db/dbs> orapwd file=/oracle/app/product/11gR2/db/dbs/orapwora11g1 entries=10 force=y Enter password for SYS: oracle@test4_5:/oracle/app/product/11gR2/db/dbs> ls -ls orapwora11g14 -rw-r----- 1 oracle oinstall 2560 2012-10-21 09:56 orapwora11g1oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus sys/oracle@ora11g5 as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 09:57:24 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL> 6、登陆用户不是sysdba用户问题现象：创建一个用户oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus / as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 09:58:17 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL> create user systest identified by oracle;User created.SQL> grant dba to systest;Grant succeeded. 可以以普通用户模式登陆：oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus systest/oracle@ora11g5SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 09:59:24 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL>  但是不能以sysdba用户登陆oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus systest/oracle@ora11g5 as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 10:00:51 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.ERROR:ORA-01031: insufficient privileges
Enter user-name: ERROR:ORA-01017: invalid username/password; logon denied
Enter user-name:  解决方法：如果sys用户以sysdba用户无法登陆，并且排除上面原因后，可能sys用户不具有sysdba权限：oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus / as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 10:01:02 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL> grant sysdba to systest;Grant succeeded.oracle@test4_5:/oracle/app/product/11gR2/db/dbs> sqlplus systest/oracle@ora11g5 as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Sun Oct 21 10:01:52 2012Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing options
SQL> 回收掉sysdba权限SQL> revoke sysdba from systest;Revoke succeeded. 7、sqlnet.ora配置这部分来源于：http://3ms.huawei.com/hi/group/1415/thread_1168963.htmlSQLNET.SEND_TIMEOUT = 360SQLNET.RECV_TIMEOUT = 360NAMES.DIRECTORY_PATH= (TNSNAMES, onames, hostname)SQLNET.INBOUND_CONNECT_TIMEOUT = 360SQLNET.EXPIRE_TIME=360
SEND_TIMEOUT、RECV_TIMEOUT设置在指定的时间间隔内必须有数据接收/发送，否则ORACLE判断为超时，目的是为了防止长时间的等待SQLNET.INBOUND_CONNECT_TIMEOUT设置连入数据库后必须在多长时间内完成认证，超过此时间没有完成，数据库会断开此连接SQLNET.EXPIRE_TIME 与ORACLE建立连接的时间如果达到这个值，服务端就发出一个测试包给客户端以判断连接是否正常，异常则释放连接
在sqlet.ora文件中加入如下可以打开监听连接跟踪日志：TRACE_LEVEL_SERVER = 16TRACE_FILE_SERVER = serverTRACE_DIRECTORY_SERVER = /opt/oracle/adminTRACE_TIMESTAMP_SERVER = ONTRACE_UNIQUE_SERVER = ONDIAG_ADR_ENABLED= OFF打开trace日志收集下相关信息
1.30 RAC OCR相关操作OCR（Oracle Cluster Registry）用于维护集群的配置信息及集群中所有数据库的配置信息。1.30.1 检查OCR完整性操作步骤步骤 1 登录操作系统。以grid用户登录Oracle 11G R2。步骤 2 检查OCR完整性。$ ocrcheckStatus of Oracle Cluster Registry is as follows :           Version                  :          3           Total space (kbytes)     :     262120           Used space (kbytes)      :        152           Available space (kbytes) :     261968           ID                       : 1684960294           Device/File Name         : /opt/oracrs/base/product/11gR2/grid/cdata/localhost/local.ocr                                      Device/File integrity check succeeded                                        Device/File not configured                                        Device/File not configured                                        Device/File not configured                                        Device/File not configured             Cluster registry integrity check succeeded             Logical corruption check bypassed due to non-privileged user若返回信息中包含有“Device/File integrity check succeeded”，则说明检查OCR完整性成功，且OCR配置信息完整。----结束1.30.2 备份OCR操作步骤步骤 1 查看系统是否已自动备份。 系统默认会自动备份OCR。以grid用户登录Oracle 11G R2，执行如下命令。$ ocrconfig -showbackup系统返回类似如下信息：linux0105     2013/03/14 07:55:05     /crs/cdata/linux_cluster/backup00.ocr  linux0105     2013/03/14 03:55:05     /crs/cdata/linux_cluster/backup01.ocr  linux0105     2013/03/13 23:55:05     /crs/cdata/linux_cluster/backup02.ocr  linux0105     2013/03/12 07:55:04     /crs/cdata/linux_cluster/day.ocr  linux0105     2013/03/07 02:45:52     /crs/cdata/linux_cluster/week.ocr返回信息显示系统已自动备份OCR。如果系统未自动备份，可执行步骤2进行手动备份。步骤 2 以root用户登录操作系统，手动备份OCR。 对于Oracle 11G R2，可执行如下任一命令：# $GRID_HOME/bin/ocrconfig -manualbackup# $GRID_HOME/bin/ocrconfig -export /home/grid/ocrbak.ocr----结束1.30.3 恢复OCR操作步骤步骤 1 以root用户登录操作系统。步骤 2 在各个节点停止CRS。 对于Oracle 11G R2执行如下命令：# $GRID_HOME/bin/crsctl stop crs -f步骤 3 执行恢复操作。 对于Oracle 11G R2执行如下任一命令：# $GRID_HOME/bin/ocrconfig -import /oracle/db/ocrbak.ocr# $GRID_HOME/bin/ocrconfig -restore /oracle/db/ocrbak.ocr步骤 4 在各个节点依次重启CRS。 对于Oracle 11G R2执行如下命令：# $GRID_HOME/bin/crsctl start crs步骤 5 校验OCR。 以grid用户登录Oracle 11G R2执行如下命令：$ cluvfy comp ocr -n all系统返回类似如下信息：Verifying OCR integrity   Checking OCR integrity...  Checking the absence of a non-clustered configuration... All nodes free of non-clustered, local-only configurations.  Uniqueness check for OCR device passed.  Checking the version of OCR... OCR of correct Version "2" exists.  Checking data integrity of OCR... Data integrity check for OCR passed.  OCR integrity check passed.  Verification of OCR integrity was successful. ----结束1.30.4 查看OCR内容操作步骤步骤 1 登录操作系统。以grid用户登录Oracle 11G R2。步骤 2 使用ocrdump工具将OCR的内容导出。$ ocrdump /home/grid/ocr.txt步骤 3 通过vi查看OCR内容。----结束1.30.5 增加或删除OCR操作步骤步骤 1 以root用户登录操作系统。步骤 2 增加OCR磁盘。 在Oracle 11G R2版本中执行如下命令： R2版本中最多可存在5个OCR。# $GRID_HOME/bin/ocrconfig -add +data其中“+data”为ASM磁盘组名称，请以实际替换。OCR增加完成后，可执行ocrcheck命令进行查看。
 删除OCR后，确保系统至少剩余一个可用的OCR。步骤 3 删除OCR磁盘。 在Oracle 11G R2版本中执行如下命令：# $GRID_HOME/bin/ocrconfig -delete +olddg其中，“+olddg”为ASM磁盘组名称，请以实际替换。----结束
1.31 检查表空间占用情况 检查磁盘空间：观察磁盘使用的占用率；（注意：包含TEMP表空间统计） 数据库空间SQL> set line 1024;SQL> SELECT D.TABLESPACE_NAME,SPACE "SUM_SPACE(M)",BLOCKS SUM_BLOCKS,SPACE-NVL(FREE_SPACE,0) "USED_SPACE(M)",ROUND((1-NVL(FREE_SPACE,0)/SPACE)*100,2) "USED_RATE(%)",FREE_SPACE "FREE_SPACE(M)"FROM (SELECT TABLESPACE_NAME,ROUND(SUM(BYTES)/(1024*1024),2) SPACE,SUM(BLOCKS) BLOCKS FROM DBA_DATA_FILES GROUP BY TABLESPACE_NAME) D,(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES)/(1024*1024),2) FREE_SPACE FROM DBA_FREE_SPACE GROUP BY TABLESPACE_NAME) FWHERE D.TABLESPACE_NAME=F.TABLESPACE_NAMEUNION ALLselect d.TABLESPACE_NAME,SPACE "SUM_SPACE(M)",BLOCKS SUM_BLOCKS,USED_SPACE "USED_SPACE(M)",ROUND(NVL(USED_SPACE,0)/SPACE*100,2) "USED_RATE(%)",NVL(FREE_SPACE,0) "FREE_SPACE(M)" FROM(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES)/(1024*1024),2) SPACE,SUM(BLOCKS) BLOCKS FROM DBA_TEMP_FILES GROUP BY TABLESPACE_NAME) D,(SELECT TABLESPACE_NAME,ROUND(SUM(BYTES_USED)/(1024*1024),2) USED_SPACE,ROUND(SUM(BYTES_FREE)/(1024*1024),2) FREE_SPACE FROM V$TEMP_SPACE_HEADER GROUP BY TABLESPACE_NAME) FWHERE D.TABLESPACE_NAME=F.TABLESPACE_NAMEorder by "USED_RATE(%)" desc;   2    3    4    5    6    7    8    9   10  
TABLESPACE_NAME         SUM_SPACE(M) SUM_BLOCKS USED_SPACE(M) USED_RATE(%) FREE_SPACE(M)------------------------------ ------------ ---------- ------------- ------------ -------------UNDOTBS2          1000 128000       542.25     54.23  457.75UNDOTBS1          1000 128000       453.25     45.33  546.75SYSAUX           2000 256000       500.94     25.05 1499.06SYSTEM           2000 256000       353.87     17.69 1646.13SDU_USER_DAT    200  25600        22.56     11.28  177.44SDU_USER_IDX    100  12800     1  1      99TEMP           2024 259072     7       .35    2017USERS           1000 128000     1        .1     999
8 rows selected.1.32 察看碎片 
SQL> set line 1024;SQL> select substr(ts.tablespace_name,1,12) "Tspace",       tf.blocks "Blocks",       sum(f.blocks) "Free",       count(*) "Pieces",       max(f.blocks) "Biggest",       min(f.blocks) "Smallest",       round(avg(f.blocks)) "Average",       sum(decode(sign(f.blocks-5),-1,f.blocks,0)) "Dead"from   dba_free_space f,       dba_data_files tf,       dba_tablespaces tswhere  ts.tablespace_name=f.tablespace_nameand    ts.tablespace_name = tf.tablespace_namegroup by ts.tablespace_name,tf.blocks;  2    3    4    5    6    7    8    9   10   11   12   13   14  
Tspace           Blocks   Free    Pieces    Biggest   Smallest    Average  Dead------------------------------------------------ ---------- ---------- ---------- ---------- ---------- ---------- ----------SYSTEM           256000 210704  2     210688      16     105352     0SDU_USER_IDX           12800  12672  1      12672   12672      12672     0UNDOTBS2          128000  58592        57      11392       8       1028     0SDU_USER_DAT           20480  22712  2      17720    4992      11356     0SYSAUX           256000 191880  9     184064       8      21320     0UNDOTBS1          128000  69984        25      42240       8       2799     0USERS           128000 127872  1     127872  127872     127872     0SDU_USER_DAT            5120  22712  2      17720    4992      11356     0
8 rows selected.
1.33 查找性能差的 SQL从操作系统中分析过高的CPU占用和磁盘I/O是由一个还是多个Oracle进程引起的。如果操作系统工具显示大量CPU的消耗是由某些Oracle进程占用，那么需要分析这些进程在长时间的执行那些SQL语句，可以通过作SQL TRACE进行跟踪或者观察Session调用的SQL语句主要是那一些。 --检查进程的sql语句  通过TOP检查性能 select p.spid, s.sid, q.sql_text, s.last_call_et, s.status   from v$process p,        v$session s,        v$sqltext q  where p.addr = s.paddr    and s.sql_address = q.address    and p.spid = 27053    --操作系统进程号，需要根据实际情况进行更改  order by s.sid, q.piece;如果CPU消耗分布在大多数的Oracle进程中，Cpu Other在相应时间中占有大部分，那么，需要分析statspack报告中的SQL ordered by Gets的语句，从中找到逻辑读最高的SQL语句进行优化。如果从操作系统中观察到磁盘I/O很高（sar –d进行观察），那么需要分析statspack报告中SQL ordered by Reads的语句，从中找到物理读最高的SQL语句进行优化。1.34 查看redo文件大小
SQL> set line 1024;SQL> col MEMBER for a50;SQL> select a.thread#,a.group#,b.member,a.status,b.type, a.bytes/(1024*1024)||'MB' as "SIZE" from v$log a, v$logfile b where a.group# = b.group# order by a.thread#,a.group#,b.member;  2    3    4    5  
   THREAD#     GROUP# MEMBER       STATUS    TYPE   SIZE---------- ---------- -------------------------------------------------- ---------------- ------- ------------------------------------------  1    11 +DG_ORA/ora11g/redo1_11.log    INACTIVE   ONLINE  200MB  1    12 +DG_ORA/ora11g/redo1_12.log    CURRENT   ONLINE  200MB  1    13 +DG_ORA/ora11g/redo1_13.log    INACTIVE   ONLINE  200MB  2    21 +DG_ORA/ora11g/redo2_21.log    INACTIVE   ONLINE  200MB  2    22 +DG_ORA/ora11g/redo2_22.log    INACTIVE   ONLINE  200MB  2    23 +DG_ORA/ora11g/redo2_23.log    CURRENT   ONLINE  200MB
6 rows selected..1.35 检查后台作业和批量处理的事务，以及长时间处理的session
检查后台作业和批量处理的事务，以及长时间处理的session。 --检查运行时间超过20s的session和sql语句 select p.spid, s.sid, s.event, s.sql_id,  q.sql_text, s.last_call_et, s.status   from v$process p,        v$session s,        v$sqltext q  where p.addr = s.paddr    and p.background <> 1 and s.sql_address = q.address    and s.status = 'ACTIVE'    and s.last_call_et > 20  order by s.sid, q.piece;
1.36 检查动态性能视图，从中找到资源占用多的SQL语句Top 10 by Buffer Gets:    set linesize 100  set pagesize 100  select *  from (select substr(sql_text, 1, 100) sql,               buffer_gets,               executions,               buffer_gets / executions "gets/exec",               hash_value,               address          from v$sqlarea         where buffer_gets > 10000           and executions > 1         order by buffer_gets desc) where rownum <= 10;   Top 10 by Physical Reads:    set linesize 100  set pagesize 100  select *   from (select substr(sql_text, 1, 100) sql,                disk_reads,                executions,                disk_reads / executions "reads/exec",                hash_value,                address           from v$sqlarea          where disk_reads > 1000            and executions > 1          order by disk_reads desc)  where rownum <= 10;   Top 10 by Executions:    set linesize 100  set pagesize 100  select *   from (select substr(sql_text, 1, 100) sql,                executions,                rows_processed,                rows_processed / executions "rows/exec",                hash_value,                address           from v$sqlarea          where executions > 100          order by executions desc)  where rownum <= 10;   Top 10 by Parse Calls:    set linesize 100  set pagesize 100  select *   from (select substr(sql_text, 1, 100) sql,                parse_calls,                executions,                hash_value,                address           from v$sqlarea          where parse_calls > 1000          order by parse_calls desc)  where rownum <= 10;   Top 10 by Sharable Memory:    set linesize 100  set pagesize 100  select *   from (select substr(sql_text, 1, 100) sql,                sharable_mem,                executions,                hash_value,                address           from v$sqlarea          where sharable_mem > 1048576          order by sharable_mem desc)  where rownum <= 10;   Top 10 by Version Count:  set linesize 100  set pagesize 100  select *   from (select substr(sql_text, 1, 100) sql,                version_count,                executions,                hash_value,                address           from v$sqlarea          where version_count > 20          order by version_count desc)  where rownum <= 10;1.37 查看ASM磁盘大小和使用情况SQL> set linesize 150;SQL> col name for a30;SQL> col path for a30;SQL> select name,path,voting_file,total_mb,free_mb from v$asm_disk;
NAME          PATH         VOT   TOTAL_MB FREE_MB------------------------------ ------------------------------ --- ---------- ----------DG_ORA_0000         /dev/diskgroup/dg_ora       N        10240     427DG_OCR_0000         /dev/diskgroup/dg_ocr       Y  1024     628DG_INDEX_0000         /dev/diskgroup/dg_index       N  3072    2562DG_DATA_0000         /dev/diskgroup/dg_data       N  3072    2358DG_BACKUP_0000         /dev/diskgroup/dg_backup       N  5120    5014
SQL> select group_number,name,total_mb,free_mb,compatibility from v$asm_diskgroup;
GROUP_NUMBER NAME         TOTAL_MB   FREE_MB COMPATIBILITY------------ ------------------------------ ---------- ---------- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------    1 DG_OCR      1907      1511 11.2.0.0.0    4 DG_BACKUP      8192      8090 11.2.0.0.0    2 DG_INDEX      5120      4610 11.2.0.0.0    3 DG_DATA      7168      6454 11.2.0.0.0    5 DG_ORA     18572      5218 11.2.0.0.01.38 查看redo日志切换频率
获取三天内的日志切换频率
SQL> select a.thread#,row_number() over (partition by a.thread# order by a.thread#) num,to_char(b.first_time, 'yyyy-mm-dd hh24:mi:ss') start_time,to_char(a.first_time, 'yyyy-mm-dd hh24:mi:ss') end_time,round(((a.first_time - b.first_time) * 24) * 60, 2) minutes from v$log_history a, v$log_history b where a.first_change# = b.next_change# and a.thread# = b.thread# and a.first_time > sysdate - 3 order by a.thread#, a.stamp asc;
   THREAD#   NUM START_TIME   END_TIME   MINUTES---------- ---------- ------------------- ------------------- ----------  1     1 2014-04-13 05:00:46 2014-04-14 04:17:08  1396.37  1     2 2014-04-14 04:17:08 2014-04-15 04:17:40  1440.53  1     3 2014-04-15 04:17:40 2014-04-15 17:00:55   763.25  1     4 2014-04-15 17:00:55 2014-04-16 04:18:16   677.351.39 检查数据文件IO分布与性能通过检查数据文件IO统计，预防存储IO错误或规划不合理。OLTP（on-line transaction processing）系统平均物理读时间小于20ms（“avreads(ms)”列）。如果查询结果中“avreads(ms)”列取值大于或等于20ms，但其对应的“PHYREADS”列取值小于800，则巡检仍通过。操作步骤步骤 1 以数据库管理用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 检查数据文件IO分布与性能。SQL> set line 1024;SQL> col name for a50;SQL> select ts#, file#, name, "avreads(ms)", phyreads, "avwrites(ms)", phywrites from (select b.ts#,b.file#,b.name,ceil(a.value * 10) as "avreads(ms)",c.value phyreads,ceil(d.value * 10) as "avwrites(ms)",e.value phywrites from v$metric a, v$datafile b, v$metric c, v$metric d, v$metric e where a.entity_id = b.file# and a.metric_id = 7000 and c.metric_id = 7002 and d.metric_id = 7001 and e.metric_id = 7003 and c.entity_id = a.entity_id and d.entity_id = a.entity_id and e.entity_id = a.entity_id) order by ts#,file#;
       TS# FILE# NAME       avreads(ms)   PHYREADS avwrites(ms)  PHYWRITES---------- ---------- -------------------------------------------------- ----------- ---------- ------------ ----------  0     1 +DG_ORA/ora11g/ora_system        0       0     0       0  1     2 +DG_ORA/ora11g/ora_sysaux01       0       0    10       1  2     3 +DG_ORA/ora11g/ora_rbs01        0       0    10       1  4     4 +DG_ORA/ora11g/ora_rbs02        0       0     0       0  5     5 +DG_ORA/ora11g/ora_user        0       0     0       0  6     6 +DG_DATA/sdu_user_data_01        0       0     0       0  6     8 +DG_DATA/sdu_user_data_02        0       0     0       0  7     7 +DG_INDEX/sdu_user_index_01       0       0     0       0
8 rows selected.
1.40 检查软分析百分比通过检查Oracle数据库软分析比例，预防SQL语句不合理的编码。软分析百分比高于99%。操作步骤步骤 1 以数据库管理用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 检查软分析百分比。SQL> select sum(a.value)/count(*) pct from v$metric_history a where a.metric_name = 'Soft Parse Ratio' and group_id = 2 and a.begin_time >= sysdate - 1 and a.end_time < sysdate;PCT ------------- 100如上信息说明，“PCT”列为软分析百分比，大小为100%。1.41 检查库缓存命中率通过检查库缓存命中率，预防SQL语句硬编码导致业务响应时间过长。库缓存命中率高于99%。操作步骤步骤 1 以数据库管理用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba'步骤 3 检查库缓存命中率。SQL> select sum(a.value)/count(*) pct from v$metric_history a where a.metric_name = 'Library Cache Hit Ratio' and group_id = 2 and a.begin_time >= sysdate - 1 and a.end_time < sysdate;
PCT----------94.0139328如上信息说明，“PCT”列为库缓存命中率，大小为99.4112278722774%。1.42 检查锁与library闩锁等待系统中如果出现严重的锁等待或者library闩锁等待，则会降低并发性，并可能导致系统hang住。当系统反应慢或者活动进程数高的时候，需要检查是否存在锁等待与library闩锁等待。不存在锁等待或者library闩锁等待。操作步骤步骤 1 以数据库管理用户登录操作系统。步骤 2 登录数据库。$ sqlplus '/ as sysdba' 步骤 3 检查锁与library闩锁等待。3. 查询锁等待。SQL> select 'session ' || c.locker ||' lock session ' || c.locked ||', alter system kill session ' ||'''' || c.locker || ',' ||d.serial# || '''' as "result" from ( select a.sid locked,b.sid locker from v$lock a, v$lock b where a.request > 0 and a.id1 = b.id1 and a.id2 = b.ID2 and a.type = b.type and a.addr <> b.addr) c,v$session d where c.locker = d.sid; 如果返回结果为空，则表示系统无锁等待事件。4. 查询library闩锁等待。SQL> select 'session ' || d.locker ||' lock session ' || d.locked ||', alter system kill session ' ||'''' || d.locker || ',' ||d.serial# || '''' as "result" from ( select a.locker,a.serial#,a.locked,row_number() over( partition by a.locker, a.locked order by a.locker ) as rn from ( select s.sid locker, s.serial#,w.sid locked from dba_kgllock k, v$session s,v$session_wait w where w.event like 'library cache%' and k.kgllkhdl = w.p1raw and k.kgllkuse = s.saddr and s.sid <> w.sid) a) d where d.rn = 1; 如果返回结果为空，则表示系统无library闩锁等待事件。1.43 查找全表扫描的SQL语句查看是否有应用的SQL语句需要执行全表扫描，如果有，则需要分析其性能SQL>select sql_text from v$sqltext t, v$sql_plan p Where t.hash_value=p.hash_value and p.operation='INDEX' and p.OPTIONS='FULL SCAN' Order by p.HASH_VALUE, t.piece
1.44 如何确定哪个表空间读写频繁？
SQL> set line 1024;SQL> select name,phyrds,phywrts,readtim,writetim from v$filestat a,v$dbfile b where a.file# = b.file# order by readtim desc;
NAME                                                                      PHYRDS PHYWRTS    READTIM   WRITETIM--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------- ---------- ---------- ----------+DG_ORA/ora11g/ora_sysaux01                                                              4379    6408       1005  2782+DG_ORA/ora11g/ora_system                                                              4465     192        628    88+DG_ORA/ora11g/ora_rbs01                                                                36    1151  14   568+DG_DATA/sdu_user_data_02                                                                 6       2   2     0+DG_INDEX/sdu_user_index_01                                                                 7       2   1     0+DG_DATA/sdu_user_data_01                                                                 7       2   1     0+DG_ORA/ora11g/ora_user                                                                  6       2   1     0+DG_ORA/ora11g/ora_rbs02                                                                 6       2   1     0
8 rows selected.
1.45 检查SQL是否绑定变量通过检查SQL绑定变量的情况，预防数据库响应缓慢或占用过多内存的故障。
SQL> set line 1024;SQL> select substr(sql_text, 1, 40) "SQL", count(*), sum(executions) "TotExecs" from v$sqlarea where executions < 5 group by substr(sql_text, 1, 40) having count(*) > 30 order by 2 desc;
SQL                       COUNT(*)   TotExecs---------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------- ----------select /*+ FIRST_ROWS(1) PARALLEL("WRH$_                686    686SELECT count(*) FROM sys.wri$_adv_execut                432    4321.46 获得用户的表记录数超过1000的表名称如下以sys用户登陆，查询sys用户下的记录数大于1000的表
oracle@test2_3:~> sqlplus / as sysdba;
SQL*Plus: Release 11.1.0.7.0 - Production on Tue Apr 22 14:37:14 2014
Copyright (c) 1982, 2008, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.1.0.7.0 - 64bit ProductionWith the Partitioning, Oracle Label Security, OLAP, Data Mining,Oracle Database Vault and Real Application Testing options
SQL> create   or   replace   procedure   p_rowcount_big  asv_count   number:=0;cursor   c_user_tb   is   select   table_name   from   user_tables;beginfor   v_cur   in   c_user_tb   loopexecute   immediate   'select   count(1)   from   '||v_cur.table_name   into   v_count;if   v_count> 1000   then  dbms_output.put_line( 'Table   Name, '||v_cur.table_name|| '   ,Rowcount, '||v_count);end   if;end   loop;end   p_rowcount_big;/  2    3    4    5    6    7    8    9   10   11   12   13  Procedure created. SQL> set serveroutput onSQL> exec p_rowcount_big; 
Table Name, ICOL$   ,Rowcount, 6548Table Name, IND$   ,Rowcount, 3712Table Name, COL$   ,Rowcount, 74067Table Name, TAB$   ,Rowcount, 2397Table Name, COLTYPE$  ,Rowcount, 1946Table Name, ATTRCOL$  ,Rowcount, 1189Table Name, TYPE_MISC$   ,Rowcount, 2669Table Name, SEG$   ,Rowcount, 6915Table Name, OBJ$   ,Rowcount, 67086Table Name, CON$   ,Rowcount, 9699Table Name, CCOL$   ,Rowcount, 11900Table Name, CDEF$   ,Rowcount, 9698Table Name, OBJAUTH$  ,Rowcount, 29714Table Name, SYN$   ,Rowcount, 26036Table Name, VIEW$   ,Rowcount, 4291Table Name, DEPENDENCY$   ,Rowcount, 123970Table Name, ACCESS$ ,Rowcount, 85391Table Name, COM$   ,Rowcount, 14544Table Name, TRIGGERCOL$   ,Rowcount, 1724Table Name, PROCEDURE$   ,Rowcount, 2916Table Name, PROCEDUREINFO$   ,Rowcount, 20707Table Name, ARGUMENT$   ,Rowcount, 99930Table Name, SOURCE$ ,Rowcount, 555688Table Name, IDL_UB1$  ,Rowcount, 40833Table Name, IDL_CHAR$   ,Rowcount, 5509Table Name, IDL_UB2$  ,Rowcount, 11494Table Name, IDL_SB4$  ,Rowcount, 15576Table Name, SETTINGS$   ,Rowcount, 46056Table Name, PROCEDUREC$   ,Rowcount, 1107Table Name, PROCEDUREPLSQL$ ,Rowcount, 13907Table Name, WARNING_SETTINGS$   ,Rowcount, 5898Table Name, PLSCOPE_IDENTIFIER$   ,Rowcount, 2047Table Name, PLSCOPE_ACTION$ ,Rowcount, 4724Table Name, SMON_SCN_TIME   ,Rowcount, 1557BEGIN p_rowcount_big ; END; 如果表的记录数过多，需要使用分区表技术。
1.47 获得用户以及授权信息的DDL
通过如下PLSQL，可以获知创建用户的命令以及赋予的权限。
SQL> set serveroutput on size 1000000set verify offundefine user_namedeclarev_name varchar2(30) := upper('&user_name');no_grant exception;pragma exception_init( no_grant, -31608 );begindbms_metadata.set_transform_param(dbms_metadata.SESSION_TRANSFORM, 'SQLTERMINATOR', TRUE);dbms_output.enable(1000000);dbms_output.put_line(dbms_metadata.get_ddl('USER',v_name));begindbms_output.put_line(dbms_metadata.get_granted_ddl('SYSTEM_GRANT',v_name));exceptionwhen no_grant then dbms_output.put_line('No system privs granted');end;begindbms_output.put_line(dbms_metadata.get_granted_ddl('ROLE_GRANT',v_name));exceptionwhen no_grant then dbms_output.put_line('No role privs granted');end;begindbms_output.put_line(dbms_metadata.get_granted_ddl('OBJECT_GRANT',v_name));exceptionwhen no_grant then dbms_output.put_line('No object privs granted');end;begindbms_output.put_line(dbms_metadata.get_granted_ddl('TABLESPACE_QUOTA',v_name));exceptionwhen no_grant then dbms_output.put_line('No tablespace quota specified');end;dbms_output.put_line(dbms_metadata.get_granted_ddl('DEFAULT_ROLE', v_name ));exceptionwhen others thenif SQLCODE = -31603 then dbms_output.put_line('User does not exists');else raise;end if;end;/SQL> SQL> SQL>   2    3    4    5    6    7    8    9   10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36  Enter value for user_name: sdu
   CREATE USER "SDU" IDENTIFIED BY VALUES'S:30DC40FA6E04E31376128CF9CF76769636787E8417B67AFD1DEC56DA1A49;AC8548ACF8075C8A'      DEFAULT TABLESPACE "SDU_USER_DAT"      TEMPORARY TABLESPACE "TEMP";

  GRANT UNLIMITED TABLESPACE TO "SDU";

   GRANT "CONNECT" TO "SDU";    GRANT "RESOURCE" TO "SDU";    GRANT "DBAPP"TO "SDU";
No object privs grantedNo tablespace quota specified
   ALTER USER "SDU" DEFAULT ROLE ALL;

PL/SQL procedure successfully completed.
1.48 获得数据库从Mounted到Open状态变迁的详细信息
oracle@test2_3:~> sqlplus / as sysdba;
SQL*Plus: Release 11.1.0.7.0 - Production on Wed Apr 16 12:06:08 2014
Copyright (c) 1982, 2008, Oracle.  All rights reserved.
Connected to an idle instance.
SQL> startup mount;ORACLE instance started.
Total System Global Area 8067207168 bytesFixed Size      2175640 bytesVariable Size   3825208680 bytesDatabase Buffers  4227858432 bytesRedo Buffers     11964416 bytesDatabase mounted.SQL> ALTER SESSION SET EVENTS '10046 TRACE NAME CONTEXT FOREVER, LEVEL 12';
Session altered.
SQL> ALTER DATABASE OPEN;
Database altered.
SQL> ALTER SESSION SET EVENTS '10046 TRACE NAME CONTEXT OFF';
Session altered.
SQL> SHOW PARAMETER USER_DUMP_DEST;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------user_dump_dest        string  /opt/oracle/app/diag/rdbms/i2k       db/i2kdb/traceSQL> ORADEBUG SETMYPIDStatement processed.SQL> ORADEBUG TRACEFILE_NAME/opt/oracle/app/diag/rdbms/i2kdb/i2kdb/trace/i2kdb_ora_16410.trc
在/opt/oracle/app/diag/rdbms/i2kdb/i2kdb/trace/i2kdb_ora_16410.trc文件中，记录了数据库从Mounted状态到Open状态的所有详细debug信息。1.49 Alter大表时，需要关闭表的归档模式
alter用户表时，由于该表为千万级（1300万）， 产生大量归档日志，造成oracle数据库io频繁，更新过程很慢，建议在更新前关闭该表的归档模式，命令为alter table xxx nologging, 更新后再开启该表的归档模式alter table xxx logging.
1.50 获取Lsnrctl的trace信息
oracle@test4_6:~> lsnrctl trace 16 LISTENER_ORA
LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 16-APR-2014 10:32:45
Copyright (c) 1991, 2011, Oracle.  All rights reserved.
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_ORA)))Opened trace file: /oracle/app/product/11gR2/db/network/trace/listener_ora.trcThe command completed successfully
1.51 导出controlfiles创建语句要求数据库至少要处于Mounted状态，才能够使用alter database backup controlfile to trace;生成crontrolfile的创建信息创建控制文件的语句SQL> alter database backup controlfile to trace; 
Database altered.
SQL> select c.value || '/' || d.instance_name || '_ora_' || a.spid || '.trc' trace from v$process a , v$session b,v$parameter c, v$instance d where a.addr = b.paddr and b.audsid = userenv('sessionid') and c.name = 'user_dump_dest';
TRACE--------------------------------------------------------------------------------/oracle/app/diag/rdbms/inomc/inomc/trace/inomc_ora_25741.trc从/oracle/app/diag/rdbms/inomc/inomc/trace/inomc_ora_25741.trc文件中，获取创建control文件的语句，内容如下:CREATE CONTROLFILE REUSE DATABASE "INOMC" NORESETLOGS  ARCHIVELOG    MAXLOGFILES 16    MAXLOGMEMBERS 3    MAXDATAFILES 100    MAXINSTANCES 8    MAXLOGHISTORY 292LOGFILE  GROUP 1 '/oracle/app/oradata/inomc/redo01.log'  SIZE 50M,  GROUP 2 '/oracle/app/oradata/inomc/redo02.log'  SIZE 50M,  GROUP 3 '/oracle/app/oradata/inomc/redo03.log'  SIZE 50M,  GROUP 4 '/oracle/app/oradata/inomc/redo4.log'  SIZE 100M,  GROUP 5 '/oracle/app/oradata/inomc/redo5.log'  SIZE 100M,  GROUP 6 '/oracle/app/oradata/inomc/redo6.log'  SIZE 100M,-- STANDBY LOGFILEDATAFILE  '/oracle/app/oradata/inomc/system01.dbf',  '/oracle/app/oradata/inomc/sysaux01.dbf',  '/oracle/app/oradata/inomc/undotbs01.dbf',  '/oracle/app/oradata/inomc/users01.dbf'CHARACTER SET ZHS16GBK;1.52 pfile和spfile文件互转pfile文件是数据库启动加载的文本文件，spfile文件是数据库启动加载的二进制文件，二者不依赖数据库是否正常即可以互相转换，只要二者存在其一，就能够将数据库从Idle instance启动到nomount状态。
SQL> create pfile='/home/oracle/pfile.ora' from spfile='/opt/oracle/app/product/11g/db/dbs/spfilei2kdb.ora';
File created.
SQL> create spfile='/home/oracle/spfile.ora' from pfile='/home/oracle/pfile.ora';
File created.1.53 测试数据库磁盘是否存在性能问题有时候需要检测数据库使用的磁阵是否存在性能问题，以判定是数据库问题还是磁阵问题，一般来说，磁阵的读写速度应该在100M/s以上，可以参考前面的章节获取数据库使用的磁盘的逻辑盘，然后使用dd命令判断是否存在性能问题。# iostat -x 1avg-cpu:  %user   %nice %system %iowait  %steal   %idle                                  0.00    0.00   30.77    0.00    0.00   69.23 Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %utilsda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00sdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00sdc               0.00     0.00    0.00    6.11     0.00  3126.72   512.00     1.50  204.50 163.50  99.85以root用户测试读取速度，可以看到sdc的读取速度只有2.5MB/s，因此磁阵有问题。sdu1a_gdr:~ #dd if=/dev/sdc of=/dev/null bs=1024k count=100;100+0 records in100+0 records out104857600 bytes (105 MB) copied, 41.408 seconds, 2.5 MB/s
1.54 查看rman备份与恢复的进度当做DataGuard或备份与恢复数据库的时候，rman命令可能长时间没有返回，那么可以使用以下SQL语句查看正在进行中的RMAN的工作进度：SQL>SELECT SID,SERIAL#,CONTEXT,SOFAR,TOTALWORK,ROUND(SOFAR/TOTALWORK*100,2) "%_COMPLETE" FROM V$SESSION_LONGOPS WHERE OPNAME LIKE 'RMAN%' AND OPNAME NOT LIKE '%aggregate%'
其中SOFAR表示已经完成的工作量，TOTALWORK表示应完成的全部工作量。最后一列表示已经完成的工作量的百分比。
我们可以在RMAN执行过程中，每隔一段时间执行一次这条查询语句。通过比较两次的返回的结果，可以判断出RMAN是否仍在正常工作中。1.55 查看impdp执行进度可以通过查询表空间的使用率判断impdp的执行进度
SQL> SELECT a.tablespace_name,ROUND (a.total_size) "total_size(MB)",ROUND (a.total_size) - ROUND (b.free_size, 3) "used_size(MB)",ROUND (b.free_size, 3) "free_size(MB)",ROUND (b.free_size/total_size * 100, 2) || '%' free_rate FROM (SELECT tablespace_name, SUM (bytes)/1024/1024 total_size FROM dba_data_files GROUP BY   tablespace_name) a,(SELECT tablespace_name, SUM (bytes)/1024/1024 free_size FROM dba_free_space GROUP BY tablespace_name) b WHERE a.tablespace_name = b.tablespace_name(+);  2  
TABLESPACE_NAME         total_size(MB) used_size(MB) free_size(MB) FREE_RATE------------------------------ -------------- ------------- ------------- -----------------------------------------SDU_USER_DAT       50      22.062    27.938 55.88%SYSAUX       600     566.062    33.938 5.66%UNDOTBS1      535      14.187   520.813 97.35%USERS         5    1  4 80%SYSTEM       670     666.687     3.313 .49%SDU_USER_IDX       50       1.625    48.375 96.75%
6 rows selected.1.56 RAC修改数据库实例级参数的方法修改数据库实例级的参数，主要是通过在alter system set命令之后，增加sid=’$ORACLE_SID’解决，示例如下：
oracle@test4_6:/oracle> sqlplus / as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Tue Feb 25 08:42:59 2014Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL> show parameter listener;NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------listener_networks       stringlocal_listener        string   (DESCRIPTION=(ADDRESS_LIST=(A       DDRESS=(PROTOCOL=TCP)(HOST=10.       137.207.41)(PORT=1521))))remote_listener        string  test-om-86-87-scan:1525 将local_listener设置为如下模式： SQL> alter system set local_listener='(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=10.137.206.86})(PORT=1526}))(ADDRESS=(PROTOCOL=TCP)(HOST=10.137.207.41)(PORT=1526))))' sid='ora11g1';System altered.  同样修改备机上的local_listener oracle@test4_10:~> sqlplus / as sysdba;SQL*Plus: Release 11.2.0.3.0 Production on Tue Feb 25 08:49:38 2014Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.2.0.3.0 - 64bit ProductionWith the Partitioning, Real Application Clusters, Automatic Storage Management, Oracle Label Security,OLAP, Data Mining, Oracle Database Vault and Real Application Testing optionsSQL> show parameter local_listener;NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------local_listener        string   (DESCRIPTION=(ADDRESS_LIST=(A       DDRESS=(PROTOCOL=TCP)(HOST=10.       137.207.42)(PORT=1521))))SQL> alter system set local_listener='(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=10.137.206.87})(PORT=1526}))(ADDRESS=(PROTOCOL=TCP)(HOST=10.137.207.42)(PORT=1526))))' sid='ora11g2';System altered.SQL> exit
1.57 怎样快速找到记不完整的表名在数据库中，数据的表、视图、索引等，常常我们只记得其中部分名字，比如dba、asm等那么可以采用如下方法快速找到，就是利用dict这个视图
SQL> desc dict; Name        Null?    Type ----------------------------------------- -------- ---------------------------- TABLE_NAME         VARCHAR2(30) COMMENTS         VARCHAR2(4000)SQL> select table_name from dict where table_name like'%ASM%';TABLE_NAME------------------------------GV$ASM_ACFSSNAPSHOTSGV$ASM_ACFSVOLUMESGV$ASM_ACFS_ENCRYPTION_INFOGV$ASM_ACFS_SECURITY_INFO…………1.58 快速查找非系统默认的参数有时候定位问题的时候，需要获取用户更改过哪些参数，可以通过如下命令一键式获取Oracle非系统默认的参数。SQL> set line 1024;SQL> col name for a30;SQL> col value for a50;SQL> select name,value from v$parameter where isdefault='FALSE';
NAME          VALUE------------------------------ --------------------------------------------------processes         1000sga_target         0memory_target         8103395328memory_max_target        8103395328control_files         /opt/oracle/app/oradata/i2kdb/control01.ctl, /opt/          oracle/app/oradata/i2kdb/control02.ctl, /opt/oracl          e/app/oradata/i2kdb/control03.ctl
db_block_size         8192compatible         11.1.0.0.0log_archive_dest_1        location=/opt/oracle/app/archivelog
NAME          VALUE------------------------------ --------------------------------------------------db_recovery_file_dest        /opt/oracle/app/flash_recovery_areadb_recovery_file_dest_size     10000undo_tablespace         UNDOTBS1remote_login_passwordfile      EXCLUSIVEdb_domaindispatchers         (PROTOCOL=TCP) (SERVICE=i2kdbXDB)local_listenerremote_listeneraudit_file_dest         /opt/oracle/app/admin/i2kdb/adumpaudit_trail         NONEdb_name          i2kdb
NAME          VALUE------------------------------ --------------------------------------------------open_cursors         300pga_aggregate_target        0diagnostic_dest         /opt/oracle/app
22 rows selected.
1.59 查询Oracle当前正在执行的SQL脚本先获取用户的Session ID，然后根据Session ID获取系统正在执行的SQL脚本。
SQL> select sid,serial#,machine,terminal,program,sql_id from v$session where type='USER';
       SID    SERIAL# MACHINE              TERMINAL         PROGRAM            SQL_ID---------- ---------- ---------------------------------------------------------------- ------------------------------ ------------------------------------------------ -------------      1105    15 test2_3              pts/0         sqlplus@test2_3 (TNS V1-V3)         dbcwa4a81wgsg
SQL> select b.sid,b.serial#,b.machine,b.terminal,b.program,a.sql_id,a.sql_text from v$sqltext a, v$session b where a.sql_id = b.sql_id and b.type='USER' and b.sql_id <> '1105';
       SID    SERIAL# MACHINE              TERMINAL         PROGRAM            SQL_ID      SQL_TEXT---------- ---------- ---------------------------------------------------------------- ------------------------------ ------------------------------------------------ ------------- ----------------------------------------------------------------      1105    15 test2_3              pts/0         sqlplus@test2_3 (TNS V1-V3)         dv48dn0h5uhth d and b.type='USER' and b.sql_id <> '1105'      1105    15 test2_3              pts/0         sqlplus@test2_3 (TNS V1-V3)         dv48dn0h5uhth .sql_text from v$sqltext a, v$session b where a.sql_id = b.sql_i      1105    15 test2_3              pts/0         sqlplus@test2_3 (TNS V1-V3)         dv48dn0h5uhth select b.sid,b.serial#,b.machine,b.terminal,b.program,a.sql_id,a
1.60 关于connection的查询1）查看有哪些用户连接主要作用是看那个用户开启了那些连接，然后用用户对应出使用改用select s.osuser os_user_name ,p.sPID,    s.sid,    decode(sign(48 - command), 1, to_char(command),'Action Code #' || to_char(command) ) action,     p.program oracle_process,     status session_status,    s.terminal terminal,    s.program program,    s.username user_name,    s.fixed_table_sequence activity_meter,    '' query,    0 memory,    0 max_memory,     0 cpu_usage,   s.serial# serial_num    from v$session s,    v$process p   where s.paddr=p.addr and    s.type = 'USER'  order by s.username, s.osuser2）根据v.sid查看对应连接的资源占用等情况select n.name,  v.value,  n.class, n.statistic#  from  v$statname n,  v$sesstat v where v.sid = 71 and  v.statistic# = n.statistic# order by n.class, n.statistic#3）根据sid查看对应连接正在运行的sql因为要在sql执行时才能抓到，构造了一个执行慢的sql，这样就可以抓到了。select /*+ PUSH_SUBQ */ command_type,  sql_text,  sharable_mem,  persistent_mem,  runtime_mem,  sorts,  version_count,  loaded_versions,  open_versions,  users_opening,  executions,  users_executing,  loads,  first_load_time,  invalidations,  parse_calls,  disk_reads,  buffer_gets,  rows_processed, sysdate start_time, sysdate finish_time, '>' || address sql_address, 'N' status from v$sqlareawhere address = (select sql_address from v$session where sid = 71)
1.61 通过all_tables查看用户创建的表获取数据库用户sdu建立的所有数据表SQL> set line 1024;SQL> select owner,table_name,tablespace_name from all_tables where owner='SDU';
OWNER          TABLE_NAME        TABLESPACE_NAME------------------------------ ------------------------------ ------------------------------SDU          VERSIONCTRLBT        SDU_USER_DATSDU          AREA_PROVINCE        SDU_USER_DATSDU          MSGCONVERSION        SDU_USER_DATSDU          SYNCSQLLOG             SDU_USER_DATSDU          VOICEMESSAGE        SDU_USER_DATSDU          CALLPLANSERVICEBIN       SDU_USER_DATSDU          T_BME_SUBSCRIBER        SDU_USER_DATSDU          T_BME_SUBSCRIBERRELA       SDU_USER_DATSDU          CALLDATATABLE        SDU_USER_DATSDU          CALLCONTEXTTABLE        SDU_USER_DATSDU          ACCPROPERTY             SDU_USER_DAT…………1.62 通过all_indexes查看用户创建的索引获取数据库用户sdu建立的所有索引。SQL> set line 1024;SQL> select owner,index_name, tablespace_name from all_indexes where owner='SDU';
OWNER          INDEX_NAME        TABLESPACE_NAME------------------------------ ------------------------------ ------------------------------SDU              IX_BASETABBAK        SDU_USER_IDXSDU              IX_NUMKEY_2        SDU_USER_IDXSDU              IX_VPNGROUP        SDU_USER_IDXSDU              IX_VPNPHONE        SDU_USER_IDXSDU              IX_VPNPHONE1        SDU_USER_IDXSDU              IX_NUMKEY_5        SDU_USER_IDXSDU              INDEX0         SDU_USER_IDXSDU              INDEX1         SDU_USER_IDXSDU              IX_RECHGMANLOG   SDU_USER_IDXSDU              SYS_C00137252        SDU_USER_DATSDU              INDEX_CHAR_5        SDU_USER_IDX…………1.63 获得指定用户单个表和索引的DDL语句getddl.sql内容如下：set heading off;set echo off;Set pages 999;set long 90000;spool get_SDU_TABLE_ddl.sql;select dbms_metadata.get_ddl('TABLE','T_BME_SUBSCRIBERRELA','SDU') from dual;select dbms_metadata.get_ddl('INDEX','I_BME_PSR_SUBID','SDU') from dual;spool off;oracle@test2_3:~> sqlplus / as sysdba @getddl.sqlSQL*Plus: Release 11.1.0.7.0 - Production on Wed Oct 31 11:17:06 2012Copyright (c) 1982, 2008, Oracle.  All rights reserved.
Connected to:Oracle Database 11g Enterprise Edition Release 11.1.0.7.0 - 64bit ProductionWith the Partitioning, Oracle Label Security, OLAP, Data Mining,Oracle Database Vault and Real Application Testing options   CREATE TABLE "SDU"."T_BME_SUBSCRIBERRELA"   ( "SERIALID" VARCHAR2(20) NOT NULL ENABLE, "SUBSCRIBERID" VARCHAR2(20) NOT NULL ENABLE, "CREATEDATE" DATE NOT NULL ENABLE, "CREATEOPERID" VARCHAR2(64), "UPDATEDATE" DATE, "UPDATEOPERID" VARCHAR2(64), "VPNSUBSCRIPTIONID" VARCHAR2(20), "VPNBGID" VARCHAR2(20), "VPNUGID" VARCHAR2(20), "VPNEFFECTIVEDATE" DATE, "VPNEXPIREDATE" DATE, "VPNRESERVEDA" VARCHAR2(32), "VPNRESERVEDB" VARCHAR2(32), "VPNRESERVEDC" VARCHAR2(32),…………1.64 获得指定用户所有表和索引的DDL语句getddl.sql内容如下：set pagesize 0set long 90000set feedback offset echo offspool sdu_schema.sqlSELECT DBMS_METADATA.GET_DDL('TABLE',u.table_name)     FROM USER_TABLES u;SELECT DBMS_METADATA.GET_DDL('INDEX',u.index_name)     FROM USER_INDEXES u;spool off;oracle@test2_3:~> sqlplus sdu/sdu@inomc @getddl.sql  CREATE TABLE "SDU"."INTERPREFIX"                                                 ( "COUNTRYCODE" VARCHAR2(8) NOT NULL ENABLE,                                  "INTERPREFIX" VARCHAR2(8) NOT NULL ENABLE,                                       PRIMARY KEY ("INTERPREFIX", "COUNTRYCODE")                                      USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS               STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645           PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)                TABLESPACE "SDU_USER_DAT"  ENABLE                                                ) PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING             STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645           PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)                TABLESPACE "SDU_USER_DAT"        …………       1.65 使用ASMCA管理DiskGroup以grid用户登陆XShell，可以查看当前的ASM实例信息，可以创建、Mount、Dismount 磁盘组 1.66 使用DBCA管理数据库实例以oracle用户登陆XShell，可以使用dbca图形化界面创建数据库实例，修改数据库实例，删除数据库实例 
1.67 使用NETCA管理数据库服务器端监听器以oracle用户登陆XShell，使用netca图形化工具可以管理服务器端监听器，包括添加、修改、删除 1.68 数据库文件损坏解决方法1.68.1 非归档模式的数据库，丢失数据文件
 故障现象 丢失某个数据库文件，造成了数据库无法启动，同时数据库处于非归档模式，也没有冷备份，启动时的错误信息如下： ORA-01157: cannot identify/lock data file 3 - see DBWR trace file ORA-01110: data file 3: 'D:\ORACLE\ORADATA\TEST\USERS01.DBF' 解决方法 将数据库启动到mount状态下： sqlplus “/ as sysdba” startup mount 从数据库中删除该数据文件 alter database datafile ‘xx’ offline drop; 打开数据库 alter database open; 备注: 该方法可正常打开数据库，但该datafile中的数据将丢失 如果误删除了system表空间的datafile,则该方法不奏效 如果该表空间还包含其它数据文件，用EXP把数据备份出来，然后删除表空间，重建表空间，将数据导入。如果不包含其它数据文件，则直接删除表空间就可以了。1.68.2 归档模式数据库丢失某数据文件，无备份, 但有该数据文件创建以来的归档日志 故障现象 归档模式的数据库，丢失了某个数据库文件，造成了数据库无法启动，同时没有数据库的全备份，但有该数据文件创建以来的归档日志，数据库无法启动： ORA-01157: cannot identify/lock data file 3 - see DBWR trace file ORA-01110: data file 3: 'D:\ORACLE\ORADATA\TEST\USERS01.DBF 解决方法 启动数据库到mount状态 startup mount 手工创建丢失的数据文件 alter database create datafile ‘oldfname’ as  ‘newfname’size xxx reuse;  利用归档日志对数据文件进行恢复 recover datafile ‘newfname’;或者 recover datafile  n; 打开数据库 alter database open; 备注: 该方法可正常打开数据库，而且不会丢失数据 该方法有两个前提 丢失的数据文件不能是系统文件 不能丢失或损坏控制文件1.68.3 非current和active的redo log损坏 故障现象 误删除了redo log，或者redo log被损坏，数据库能mount,不能open: ORA-00313: open failed for members of log group 3 of thread 1 ORA-00312: online log 3 thread 1: '/oracle10/oradata/ora10g/redo03.log'  解决方法 查询v$log视图，确认损坏的redo log group是非current和active  SQL>select group#,thread#,sequence#, archived,status from v$log; GROUP#  THREAD#  SEQUENCE#  ARCHIVED STATUS   ------         -------          ----------            --------           -------- 1                1                103                  YES      INACTIVE 2                1                104                  NO       CURRENT  3                1                102                  YES      INACTIVE 如果该日志已经归档，用下面的命令清除日志内容 Alter database clear logfile group 3; 如果该日志没有归档，用下面的命令清除日志内容 Alter database clear unarchived logfile group 3; 打开数据库 Alter database open; 尽快做一个数据库全备份1.68.4 current或active的redo log损坏 故障现象 误删除了redo log，或者redo log被损坏，数据库不能打开: ORA-00313: open failed for members of log group 2 of thread 1 ORA-00312: online log 2 thread 1: '/oracle10/oradata/ora10g/redo02.log' 解决方法 查询v$log视图，确认损坏的redo log group是current或active  SQL>select group#,thread#,sequence#, archived,status from v$log; GROUP#  THREAD#  SEQUENCE#  ARCHIVED STATUS   ------         -------          ----------            --------           -------- 1                1                2                  YES      INACTIVE 2                1                4                  NO       CURRENT  3                1                3                  YES      INACTIVE 情况1：当前日志文件还存在，只是逻辑损坏，并且当前日志没有未决事务需要实例恢复 alter database clear unarchived logfile group 2;  --不会报错 recover database until cancel; alter database open resetlogs; 一般情况下，该方法不奏效，如果clear报错，则用其它方法. 情况2：当前日志完全损坏，且有未决事务，数据库有备份 alter database clear unarchived logfile group 2;  --会报错ERROR at line 1:ORA-01624: log 1 needed for crash recovery of thread 1 restore database; recover database until cancel; --选择auto recover database until cancel;  alter datbase open resetlogs; 尽快做一个数据库全备份 情况3：当前日志完全损坏，且有未决事务，数据库无备份 shutdown immediate; _allow_resetlogs_corruption=true; startup mount pfile=‘xxx’; recover database until cancel;  alter datbase open resetlogs; shutdown immediate _allow_resetlogs_corruption=true; Startup 尽快做一个数据库全备份1.68.5 临时表空间的数据文件损坏 故障现象 临时表空间的数据文件发生损坏，系统出现故障，如何恢复 解决方法 在10g及以上版本数据库，启动数据库时，如果发现临时数据文件损坏，会自动创建，如果在数据库运行过程中，可以手工重建: create temporary tablespace temp1 tempfile ‘xx’ size xx’; alter database default temporary tablespace temp1;--系统默认临时表空间的重建需要执行这一步，否则不需要 drop tablespace temp; alter tablespace temp1 rename to temp; 在10g以前版本数据库，可以在数据库打开后或运行过程中，手工重建就可以了 alter database datafile ‘xxx’ offline drop;--如果数据库打不开，就执行这个步骤 create temporary tablespace temp1 tempfile ‘xx’ size xx’; alter database default temporary tablespace temp1;--系统默认临时表空间的重建需要执行这一步，否则不需要，9i以前版本也不需要。 drop tablespace temp; alter tablespace temp1 rename to temp;1.68.6 UNDO数据文件损坏，数据库无法启动 故障现象 Undo数据文件发生了丢失或损坏，数据库启动报错: ORA-01157: cannot identify/lock data file 2 - see DBWR trace file ORA-01110: data file 2: '/oracle10/oradata/ora10g/undotbs01.dbf' 解决方法 如果数据库有备份，则利用备份进行恢复 如果数据库没有备份，则利用重建undo表空间的方式进行恢复 startup mount alter database datafile n offline drop;(删除损坏的undo文件) alter database open; create undo tablespace xxx …; (创建一个新的undo表空间) alter system set undo_tablespace=xxx;(指向新的undo表空间) drop tablespace yyy including contents;(删除原来的undo表空间)1.68.7 控制文件损坏 故障现象 控制文件发生了损坏，数据库已经无法启动，报错信息如下： ORA-00202: controlfile: 'D:\Oracle\oradata\chen\control01.ctl' ORA-27041: unable to open file OSD-04002: unable to open file  解决方法 情况一：控制文件有镜像，且镜像控制文件没有被损坏 关闭数据库 将没有损坏的控制文件覆盖掉损坏的控制文件，或者修改参数文件的control_files参数，去掉损坏的控制文件 重新启动数据库 情况二：控制文件无镜像，或者镜像的所有控制文件都损坏了 恢复控制文件 如果控制文件有备份，从备份中恢复控制文件                     restore controlfile from ‘<your controlfile backupset>’ 如果控制文件有snapshot,将snapshot控制文件替换掉原损坏控制文件 如果做过alter database backup controlfile to trace的控制文件脚本备份，可以用trace文件中的重建脚本来创建控制文件，  如果没有备份，也没有trace备份，只能手工编写脚本创建控制文件，前提是你对数据库文件结构非常清楚 恢复和打开数据库 如果是用create controlfile …noresetlogs 方式重建的控制文件 recover database; alter database open; alter tablespace temp add tempfile ‘xx’ size xx reuse ; --对所有临时表空间做此操作 如果是用create controlfile …resetlogs方式重建的控制文件，或者通过备份或快照恢复的控制文件 recover database using backup controlfile; alter database open resetlogs; alter tablespace temp add tempfile ‘xx’ size xx reuse ; --对所有临时表空间做此操作
1.69 Dataguard相关操作Oracle DataGuard是Oracle自带的数据同步功能，将日志文件从原数据库传输到目标数据库，可以提供Oracle数据库的冗灾、数据保护、故障恢复等功能，实现数据库快速切换与灾难性恢复。1.69.1 检查容灾端是否处于standby模式确保容灾端处于standby模式，实现数据备份和灾难恢复。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录生产机数据库。$ sqlplus '/ as sysdba'步骤 3 检查生产机数据库的通道是否正常。SQL> select DEST_ID,STATUS,DATABASE_MODE,RECOVERY_MODE from v$archive_dest_status;系统返回类似如下信息：   DEST_ID STATUS    DATABASE_MODE   RECOVERY_MODE  ---------- --------- --------------- -----------------------           1 VALID     OPEN              IDLE           2 VALID     OPEN_READ-ONLY  MANAGED REAL TIME APPLY           3 INACTIVE  UNKNOWN         IDLE           4 INACTIVE  UNKNOWN         IDLE           5 INACTIVE  UNKNOWN         IDLE           6 INACTIVE  UNKNOWN         IDLE           7 INACTIVE  UNKNOWN         IDLE           8 INACTIVE  UNKNOWN         IDLE           9 INACTIVE  UNKNOWN         IDLE          10 INACTIVE  UNKNOWN         IDLE其中，生产机到容灾机数据库的通道ID为“2”。“RECOVERY_MODE”取值为“MANAGED REAL TIME APPLY”表示数据库启用了实时应用，处于“RECOVER”状态；“RECOVERY_MODE”取值为“IDLE”则表示未处于“RECOVER”状态。步骤 4 登录容灾端数据库。步骤 5 检查容灾机数据库的通道是否正常。SQL> select DEST_ID,STATUS,DATABASE_MODE,RECOVERY_MODE from v$archive_dest_status;系统返回类似如下信息：   DEST_ID STATUS    DATABASE_MODE   RECOVERY_MODE  ---------- --------- --------------- -----------------------           1 VALID     OPEN_READ-ONLY  MANAGED REAL TIME APPLY           2 VALID     UNKNOWN         IDLE           3 INACTIVE  UNKNOWN         IDLE           4 INACTIVE  UNKNOWN         IDLE           5 INACTIVE  UNKNOWN         IDLE           6 INACTIVE  UNKNOWN         IDLE           7 INACTIVE  UNKNOWN         IDLE           8 INACTIVE  UNKNOWN         IDLE           9 INACTIVE  UNKNOWN         IDLE          10 INACTIVE  UNKNOWN         IDLE          11 VALID     UNKNOWN         IDLE其中，“DEST_ID”为“1”表示生产机到容灾机数据库的通道ID。步骤 6 检查容灾端是否存在MRP0进程。SQL> select process,status,thread#,sequence#,block#,blocks from v$managed_standby;系统返回类似如下信息：PROCESS   STATUS          THREAD#  SEQUENCE#     BLOCK#    BLOCKS  ---------------- ------------------------- ---------------- ------------------------ ------------------ ----------  ARCH      CONNECTED             0          0          0          0  ARCH      CONNECTED             0          0          0          0  ARCH      CONNECTED             0          0          0          0  ARCH      CONNECTED             0          0          0          0  ARCH      CLOSING                 2         35          1        294  MRP0      APPLYING_LOG           2         36     381949    1024000  RFS        IDLE                     2         36     381951          1返回结果显示，MRP0进程中“BLOCKS”取值不为0，说明生产端的归档日志能够传送到容灾端。----结束1.69.2 启动与关闭Redo apply/Real-time apply开启Redo apply/Real-time apply将redo数据应用到容灾机数据库。Real-time apply可以实现redo数据实时应用，redo数据不需要等待归档完成，在被容灾机接收后即可被应用。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 将数据库启动到mount状态。步骤 3 启动Redo apply。 前台启动Redo applySQL> alter database recover managed standby database; 在前台启动redo应用后控制权无法回到命令窗口，直到取消redo应用。该方式不常使用，建议后台启动Redo apply。 后台启动Redo applySQL> alter database recover managed standby database disconnect;步骤 4 取消Redo apply。SQL> alter database recover managed standby database cancel;步骤 5 打开数据库。SQL> alter database open;步骤 6 启动Real-time apply。SQL> alter database recover managed standby database using current logfile disconnect from session;步骤 7 取消Real-time apply。SQL> alter database recover managed standby database cancel;----结束1.69.3 监控redo log传送状态监控生产机与容灾机之间的redo log传送状态，确保系统日志正常归档。操作步骤步骤 1 以oracle用户登录操作系统。步骤 2 登录生产机数据库。$ sqlplus '/ as sysdba'步骤 3 检查生产数据库中最新的redo log序列号。SQL> SELECT MAX(SEQUENCE#), THREAD# FROM V$ARCHIVED_LOG GROUP BY THREAD#;系统返回类似如下信息：MAX(SEQUENCE#)    THREAD#  -------------- ----------            91          1步骤 4 检查生产机数据库中redo log的归档情况。SQL> col DESTINATION format a30;SQL> SELECT DESTINATION, STATUS, ARCHIVED_THREAD#, ARCHIVED_SEQ# FROM GV$ARCHIVE_DEST_STATUS WHERE STATUS <> 'DEFERRED' AND STATUS <> 'INACTIVE'; 如果容灾端状态正常，则返回如下信息：
DESTINATION         STATUS  ARCHIVED_THREAD# ARCHIVED_SEQ#------------------------------ --------- ---------------- -------------+DG_BACKUP         VALID   2      69droradg11g         VALID   2     114+DG_BACKUP         VALID   1     114droradg11g         VALID   1     114其中“droradg11g”为生产端往容灾端复制的通道中定义的容灾网络服务器别名。 如果容灾端没有启动或者复制网络异常，或者容灾端的归档路径有问题，那么返回结果可能如下：DESTINATION         STATUS  ARCHIVED_THREAD# ARCHIVED_SEQ#------------------------------ --------- ---------------- -------------+DG_BACKUP         VALID   0       0droradg11g         ERROR   1     114+DG_BACKUP         VALID   0       0droradg11g         ERROR   0      68返回信息中“STATUS”取值为“ERROR”。步骤 5 查询未被容灾端接受的redo log序列号。 不包含最后一次基线前的redo log。假设“dest_id=1”表示本地归档路径，“dest_id=2”表示生产机到容灾机的归档通道。请以实际取值替换，可执行SELECT DESTINATION,DEST_ID FROM V$ARCHIVE_DEST_STATUS;语句查询。SQL> SELECT LOCAL.thread#, LOCAL.sequence#FROM (SELECT thread#, sequence# FROM v$archived_logWHERE dest_id = 1AND resetlogs_id = (SELECT resetlogs_idFROM v$database_incarnationWHERE status = 'CURRENT'AND rownum = 1)) LOCALWHERE LOCAL.sequence# NOT IN(SELECT sequence#FROM v$archived_logWHERE dest_id = 2AND thread# = LOCAL.thread# AND resetlogs_id = (SELECT resetlogs_idFROM v$database_incarnationWHERE status = 'CURRENT'AND rownum = 1));----结束1.69.4 手工处理中断的归档日志文件如果容灾端上出现归档日志中断，并且这些日志文件仍可获取到，例如生产机上还保留着这些日志文件，或者可以从备份集中获取，那么可以手工处理中断的归档日志文件。操作步骤步骤 1 确认容灾端是否存在归档中断。查找没有传送到容灾端的所有日志序号，具体操作请参见监控redo log传送状态步骤 2 根据日志序列号查找对应的归档文件。例如，中断的日志序列号为108。SQL> SELECT NAME FROM V$ARCHIVED_LOG WHERE THREAD#=1 AND DEST_ID=1 AND SEQUENCE# =108;系统返回类似如下信息：
NAME--------------------------------------------------------------------------------+DG_BACKUP/ora11g/archivelog/2014_04_16/thread_1_seq_108.292.844998329步骤 3 以grid用户登陆asmcmd，将中断的归档日志文件导出到文件系统上 grid@test4_6:~> asmcmdASMCMD> cp +DG_BACKUP/ora11g/archivelog/2014_04_16/thread_1_seq_108.292.844998329 /tmp/redo_log_108copying +DG_BACKUP/ora11g/archivelog/2014_04_16/thread_1_seq_108.292.844998329 -> /tmp/redo_log_108步骤 4 复制中断的归档日志文件到容灾端。步骤 5 在容灾端注册归档日志文件。SQL> alter database register logfile '/tmp/redo_log_108';Database altered.请以实际替换归档日志文件及路径。注册完成后，MPR进程会捕捉该信息并启动应用服务，不需要人工干预。----结束1.69.5 Dataguard其他常用操作介绍Dataguard相关的常用SQL语句。常用操作如下： 关闭生产机到容灾机间的通道：SQL> alter system set log_archive_dest_state_2=defer scope=memory; 恢复生产机与容灾机间的通道：SQL> alter system set log_archive_dest_state_2=enable;SQL> alter system switch logfile; 关闭数据库：− 在关闭容灾库前，先关闭redo apply：SQL> alter database recover managed standby database cancel;SQL> shutdown immediate;− 在关闭生产库前，先做一次日志切换：SQL> alter system switch logfile;SQL> shutdown immediate; 检查Dataguard保护模式:SQL> select open_mode, protection_mode, database_role from v$database;系统返回类似如下信息：OPEN_MODE  PROTECTION_MODE      DATABASE_ROLE  ---------- -------------------- ----------------  READ WRITE MAXIMUM PERFORMANCE  PRIMARY 修改Dataguard保护模式。
 切换到MAXIMUM PROTECTION时，需要先将数据库执行到“mount”状态。SQL> alter database set standby database to maximize availability;SQL> alter database set standby database to maximize performance;SQL> alter database set standby database to maximize protection; Data Guard提供三种数据保护模式：最大保护、最大可用性、和最大性能。SNE平台仅支持最大可用性和最大性能两种模式 校验DataGuard 的连通性：以oracle用户登录主备机，通过tnsping <网络服务别名>命令检测tns和lisnter是否可通。oracle@test4_6:~/ > tnsping ORADG11G
TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 16-APR-2014 18:59:16
Copyright (c) 1997, 2011, Oracle.  All rights reserved.
Used parameter files:/oracle/app/product/11gR2/db/network/admin/sqlnet.ora
Used TNSNAMES adapter to resolve the aliasAttempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.207.41)(PORT = 1522)) (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.207.42)(PORT = 1522)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = ora11g)))OK (0 msec)
oracle@test4_6:~> tnsping DRORADG11G
TNS Ping Utility for Linux: Version 11.2.0.3.0 - Production on 16-APR-2014 18:59:43
Copyright (c) 1997, 2011, Oracle.  All rights reserved.
Used parameter files:/oracle/app/product/11gR2/db/network/admin/sqlnet.ora
Used TNSNAMES adapter to resolve the aliasAttempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.207.45)(PORT = 1523)) (ADDRESS = (PROTOCOL = TCP)(HOST = 10.137.207.46)(PORT = 1523)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = drora11g)))OK (0 msec)1.69.6 归档日志本端log_archive_dest_1设置SQL> show parameter log_archive_dest_1;NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------log_archive_dest_1       string  location="+DG_BACKUP", valid_for=(ALL_LOGFILES,ALL_ROLES)1.69.7 生产端和容灾端fal_client和fal_server设置SQL> show parameter fal_client;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------fal_client        string  ORADG11GSQL> show parameter fal_server;
NAME         TYPE  VALUE------------------------------------ ----------- ------------------------------fal_server        string  DRORADG11G
1.69.8 最大性能模式和最大可用性模式的log_archive_dest_2设置在最大可用性模式下的时候：生产端：SQL> select DATABASE_ROLE,PROTECTION_MODE from v$database;
DATABASE_ROLE  PROTECTION_MODE---------------- --------------------PRIMARY   MAXIMUM AVAILABILITY 
配置方法如下：SQL>alter system set log_archive_dest_2='service=droradg11g LGWR SYNC AFFIRM delay=0 optional compression=enable max_failure=0 max_connections=1  reopen=300 db_unique_name=drora11g  net_timeout=30 valid_for=(online_logfiles,primary_role)' scope=both 容灾端：SQL> select DATABASE_ROLE,PROTECTION_MODE from v$database;
DATABASE_ROLE  PROTECTION_MODE---------------- --------------------PHYSICAL STANDBY MAXIMUM PERFORMANCE配置方法如下：SQL>alter system set log_archive_dest_2='service=oradg11g LGWR SYNC AFFIRM delay=0 optional compression=enable max_failure=0 max_connections=1  reopen=300 db_unique_name=ora11g  net_timeout=30 valid_for=(online_logfiles,primary_role)' scope=both 在最大性能模式下的时候：生产端：SQL> select DATABASE_ROLE,PROTECTION_MODE from v$database;
DATABASE_ROLE  PROTECTION_MODE---------------- --------------------PRIMARY   MAXIMUM PERFORMANCE配置方法如下：SQL>alter system set log_archive_dest_2='service=droradg11g async noaffirm delay=0 optional compression=enable max_failure=0 max_connections=1 reopen=300 db_unique_name=drora11g  net_timeout=30 valid_for=(online_logfiles,primary_role)' scope=both 容灾端：SQL> select DATABASE_ROLE,PROTECTION_MODE from v$database;
DATABASE_ROLE  PROTECTION_MODE---------------- --------------------PHYSICAL STANDBY MAXIMUM PERFORMANCE配置方法如下：SQL>alter system set log_archive_dest_2='service=oradg11g async noaffirm delay=0 optional compression=enable max_failure=0 max_connections=1 reopen=300 db_unique_name=ora11g  net_timeout=30 valid_for=(online_logfiles,primary_role)' scope=both
1.69.9 AS DataGuard实现角色反转的命令在Active-Standby DataGuard工作正常的情况下，即生产站点处于正常的写状态，容灾站点处于正常的Real Time Apply状态下的时候，可以不用重新做基线，即可实现Active变成Standby，Standby变成Active角色。操作步骤步骤 1 登录PrimaryDB： SQL>alter database commit to switchover to physical standby with session shutdownSQL>shutdown immediateSQL>startup步骤 2  登录Secondary DB： SQL>alter database commit to switchover to PRIMARY with session shutdown SQL>alter database open步骤 3 登录原Primary DB，打开日志应用 SQL>alter database recover managed standby database using current logfile disconnect from session1.69.10 将Standby数据库快速置为Active数据库如下方法介绍如果将Standby数据库快速置为Active数据库停止redo apply。SQL> alter database recover managed standby database cancel;查看redo apply是否停止。SQL> select RECOVERY_MODE from v$archive_Dest_status;系统显示如下信息，表示redo apply已经停止。RECOVERY_MODE--------------IDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLE11 rows selected.初始化failover。SQL> alter database recover managed standby database finish force;打开switchover to primary。SQL> alter database commit to switchover to primary with session shutdown;打开容灾机的实例。查看数据库的打开模式。SQL> select open_mode from v$database;正常情况下，系统显示如下信息：OPEN_MODE----------MOUNTED打开数据库的实例。SQL> alter database open;再次查看数据库的打开模式。SQL> select open_mode from v$database;正常情况下，系统显示如下信息：OPEN_MODE----------READ WRITE
1.69.11 修改容灾机数据库状态(mount->read only) SQL> select open_mode from v$database;
OPEN_MODE----------MOUNTED
SQL> alter database open read only;alter database open read only*ERROR at line 1:ORA-10456: cannot open standby database; media recovery session may be in progress
查看有另一进程,正在做recovery 操作SQL> SELECT PROCESS, STATUS, THREAD#, SEQUENCE#,BLOCK#, BLOCKS FROM V$MANAGED_STANDBY;
PROCESS   STATUS          THREAD#  SEQUENCE#     BLOCK#     BLOCKS.....................................MRP0      APPLYING_LOG          1         15       2044    1013760SQL> select RECOVERY_MODE from v$archive_Dest_status;
RECOVERY_MODE-----------------------MANAGED REAL TIME APPLYIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLEIDLE
11 rows selected.解决方法：1.停止正在做recovery 操作.SQL> recover managed standby database cancel; Media recovery complete.2.修改容灾机数据库状态(mount->read only)SQL> alter database open read only;
Database altered.3.打开Real-time APPLYSQL> ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT FROM SESSION;
Database altered.SQL> select open_mode from v$database;
OPEN_MODE----------READ ONLY



2 数据库性能问题分析常见的收集性能问题的工具AWR、ASH、ADDM等使用方法参考如下文档。 



3 SNE平台数据库工具相关能力集3.1 DataGuard工具SNE平台提供的DataGuard工具支持Oracle11gR1 NonRAC 双机对双机、单机对单机， RAC对RAC，Oracle11g R2 NonRAC双机对双机、单机对单机、RAC对RAC、RAC单实例集群对单实例集群的自动配置。支持最大性能模式和最大可用性模式两种工作模式。支持duplicate和rman两种方式配置DataGuard、一般duplicate方式比rman方式慢很多，所以实际使用中，都是使用rman方式配置DataGuard。
DataGuard工具自动化配置DataGuard，其主要工作内容就是：1） 配置生产站点和容灾站点的数据库参数，包括log_archive_config、log_archive_dest_1、log_archive_dest_2、fal_client、fal_server、db_file_name_convert、log_file_name_convert等2） 将生产站点的参数文件、控制文件、数据库和日志备份3） 将生产站点的备份拷贝到容灾站点并恢复，恢复完成后容灾站点置为real time apply状态。详细使用指导参考：《容灾安装配置指南帮助》3.2 数据库备份与恢复工具SNE平台提供的数据库备份与恢复工具支持备份ASM（RAC场景）、数据库实例数据、归档日志、控制文件、参数文件。SNE平台备份数据库只支持全量备份数据库、不支持增量备份。详细使用指导参考：《ONIP SNE备份与恢复帮助》3.3 数据库日志清理工具SNE平台在平台安装的时候，自动部署日志清理工具，防止数据库的归档日志过度占用/home/oracle/archive目录，导致磁盘空间占满，触发问题。定时任务中查看到如下命令：50 0,3,6,9,12,15,18,21 * * * su - oracle -c /opt/oracle/app/product/11g/db/oracle-log-delete/bin/arch_clear.sh >/dev/null 2>&1即为正常部署。其工作原理即是：当log_archive_dest_1中配置的路径磁盘空间占用超过80%执行run{    allocate channel t1 type disk;    crosscheck archivelog all;    delete force noprompt expired archivelog all; release CHANNEL t1; }如果执行上述命令之后，log_archive_dest_1中配置的路径磁盘空间占用仍然超过80%，那么执行run {     allocate channel t1 type disk;  crosscheck archivelog all;    delete force noprompt archivelog all;     release CHANNEL t1; }详细使用指导参考：《ONIP SNE备份与恢复帮助》
3.4 数据库维护小工具SNE平台在平台安装的时候，会对数据库做如下维护1、 在双机安装的时候，如果是数据库节点，会部署ondatabase.sh  oninit.sh  onmodeky.sh  onmode.sh  onopen.sh  onstat.sh几个小工具，这几个小工具用于双机维护数据库实例状态，包括启动、停止、查询数据库实例和监听器状态。2、 平台部署的时候，会在数据库节点执行TMG 数据库参数统一调整脚本3、 如果SNE某个网元是单机、则安装平台，会自动添加系统自启动任务，其中包括数据库自动拉起能力4、 设置数据库维护的时间SQL> col DURATION for a20;SQL> col REPEAT_INTERVAL for a60;SQL> set linesize 150;SQL>select t1.window_name,t1.repeat_interval,t1.duration from dba_scheduler_windows t1,dba_scheduler_wingroup_members t2 where t1.window_name=t2.window_name and t2.window_group_name in ('MAINTENANCE_WINDOW_GROUP','BSLN_MAINTAIN_STATS_SCHED');
WINDOW_NAME         REPEAT_INTERVAL          DURATION------------------------------ ------------------------------------------------------------ --------------------MONDAY_WINDOW         Freq=daily;ByDay=MON;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00TUESDAY_WINDOW         Freq=daily;ByDay=TUE;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00WEDNESDAY_WINDOW        Freq=daily;ByDay=WED;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00THURSDAY_WINDOW         Freq=daily;ByDay=THU;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00FRIDAY_WINDOW         Freq=daily;ByDay=FRI;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00SATURDAY_WINDOW         Freq=daily;ByDay=SAT;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00SUNDAY_WINDOW         Freq=daily;ByDay=SUN;ByHour=3;ByMinute=0;BySecond=0     +000 04:00:00
7 rows selected.3.5 数据库垃圾清理工具SNE平台在平台安装的时候，会添加如下Oracle系统垃圾清理工具定时任务0 3 * * * /opt/oracle/app/product/11g/db/oracle-log-delete/bin/oracle_clear.sh >/dev/null 2>&1oracle_clear.sh垃圾清理工具会清理如下垃圾文件1、${ORACLE_BASE}/diag/rdbms/*/${ORACLE_SID}/trace2、${ORACLE_BASE}/diag/rdbms/*/${ORACLE_SID}/cdump3、${ORACLE_BASE}/diag/tnslsnr/${host_name}/*/trace4、${ORACLE_HOME}/rdbms/audit5、${ORACLE_HOME}/network/log/6、${ORACLE_BASE}/diag/clients7、$ORACLE_BASE/diag/asm/+*/+*/alert/log*.xml8、$ORACLE_BASE /diag/asm/+*/+*/trace/9、${ORACLE_BASE}/admin/*/adump/$ORACLE_SID*.aud10、$ORACLE_BASE/diag/tnslsnr/$hostname/*/alert/log*.xml11、$ORACLE_BASE/diag/tnslsnr/$hostname/*/trace/listener*log清理的原则是：如果是单个文件，那么超过1G以后，备份移除；如果是多个文件，那么小于100个的时候，备份后移除；如果是多个文件，并且大于100个的时候，直接删除。详细使用指导参考：《ONIP SNE备份与恢复帮助》
3.6 AA容灾自动恢复工具AA容灾场景下，当发生SDUDB容灾切换后，需要恢复容灾。恢复容灾就涉及到数据库数据的一致性恢复。SNE平台提供了一个基于iDeploy开发的界面化工具，其工作原理如下：1、 冻结生产和容灾站点SDUDB双机2、 执行DataGuard工具，让生产站点和容灾站点数据保持一致性3、 闭塞生产站点的数据库写操作4、 回切容灾站点5、 清理DataGuard配置6、 解闭塞生产站点的数据库写操作
这个工具虽然使用DataGuard工具，但是不需要像工具版本DataGuardTools那样有很多参数要配置，相反，这个工具所有的DataGuard参数都是自动获取的，大幅度降低使用难度，但是这基于一个前提：生产和容灾站点数据库必须是open状态的。详细使用指导参考：《容灾安装配置指南帮助》
3.7 数据库巡检SNE平台自己的数据库巡检包，巡检的都是容灾相关的，基本可以忽略不计。SNE平台对数据库的巡检主要是集成CBB的《IT外购件 Oracle 11G R2数据库巡检指南 (V100R001_02)》，因此当我们在开局巡检的时候，数据库的巡检要从Support上获取CBB的巡检指导书和巡检包。
3.8 数据库故障收集维护助手CollectData工具可以收集数据库相关的信息，包括alert日志、pfile参数文件、spfile参数文件、数据库版本、$ORACLE_HOME/network/admin目录下的listener.ora tnsnames.ora sqlnet.ora配置、服务端监听器的状态、表空间利用率、数据文件列表、环境变量等
